var myData = {
	score :   null,
	prizeNum : null,
	cardNum : null,
	hardworkingBtn : null,
	shareToFriendBtn : null,
	userSecondKillMinScore : null
};


document.addEventListener('DOMContentLoaded', function(){
	LENOVO.act.marquee.init("marquee");
	//LENOVO.act.scrollList.init("scrollList");
	LENOVO.com.tab.init("tab","click");
	LENOVO.act.initail.init();
	LENOVO.act.list.init();
});

/*LENOVO.com.ui.toast.ready();
LENOVO.com.ui.toast.show("您好");*/


//初始化数据
LENOVO.namespace('LENOVO.act.initail');
LENOVO.act.initail = (function(){
	var
	entrance = document.querySelector("#entrance"),
	prize_entrance = document.querySelector("#prize_entrance"),
	everydayScore = document.querySelector("#everydayScore"),
	getCardBox = document.querySelector("#getCardBox"),
	shareBox = document.querySelector("#shareBox"),
	ms_box = document.querySelector("#ms_box"),
	score,
	prizeNum,
	hardworkingBtn,
	shareToFriendBtn,
	userSecondKillMinScore,
	get = function(){
		LENOVO.com.ajax.get('index.do','t='+new Date().getTime(), {"clientid":getclientid()}, function(data){
			
			myData.score = data.userScore;
			myData.prizeNum = data.prizeNumToExchange;
			myData.cardNum = data.userGuaGuaCardNum;
			myData.hardworkingBtn = data.btnStatus.hardworkingBtn;
			myData.shareToFriendBtn = data.btnStatus.shareToFriendBtn;
			myData.userSecondKillMinScore = data.userSecondKillMinScore;
			score = data.userScore;
			prizeNum = data.prizeNumToExchange;
			hardworkingBtn = data.btnStatus.hardworkingBtn;
			shareToFriendBtn = data.btnStatus.shareToFriendBtn;
			userSecondKillMinScore = data.userSecondKillMinScore;
			viewSecondKillBtn = data.btnStatus.viewSecondKillBtn;
			document.querySelector("#userSecondKillMinScore").innerHTML = data.userSecondKillMinScore;
			document.querySelector("#score").innerHTML = data.userScore;
			document.querySelector("#prizeType").innerHTML = data.prizeNumToExchange;
			document.querySelector("#cardNum").innerHTML = data.userGuaGuaCardNum;
			
			//活动结束
			if(viewSecondKillBtn){
				entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';
			}else{
				document.querySelector(".con1_l").style.display = 'none';
				document.querySelector(".con1_r").style.display = 'none';
				entrance.innerHTML = '<h2>秒杀活动已结束</h2>';
				return false;
			}
			
			if(myData.userSecondKillMinScore>0){
				//entrance.innerHTML = '<span class="btn_grey">查看详情</span>';
				entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';	
			}else{
				entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';	
			}
			if(userSecondKillMinScore==0){
				ms_box.style.display = 'none';
			}else{
				ms_box.style.display = 'block';
			}
			//showToast(prizeNum);
			if(prizeNum>0){
				prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';	
			}else{
				prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';
			}
			//每天领积分
			if(!hardworkingBtn){
				everydayScore.innerHTML = '<span class="btn_grey">已领取</a>';
			}
			//分享微信
			
			if(!shareToFriendBtn){
				shareBox.innerHTML = '<span class="btn_grey">已分享</a>';
			}
			
			
			
			//LENOVO.act.entrance.init();
			LENOVO.act.scratchLogic.init();
		});	
	},
	init = function(){
		get();
	}
	return {
		init:init
	}
})()




/**
 * 跑马灯
 * @param {String} id [容器id]
 * @usage
 *		LENOVO.act.marquee.init(id)
 */
LENOVO.namespace('LENOVO.act.marquee');
LENOVO.act.marquee = (function(){
	var
	timer = null,
	autoPlay = function(id){
		var marquee = document.querySelector("#"+id),
		marqueeCon = marquee.querySelectorAll("div.marquee_con"),
		marqueeWidth = marqueeCon[0].offsetWidth,
		left;
		marquee.style.width = marqueeWidth*2 + "px";
		marqueeCon[1].innerHTML = marqueeCon[0].innerHTML;
		timer = setInterval(function(){
			left = parseInt(marquee.style.left);
			marquee.style.left = (left - 1) + "px";	
			if(Math.abs(left)>marqueeWidth){
				marquee.appendChild(marqueeCon[0]);
				marquee.style.left = "0px";
			}
		},30);
	},
	handler = function(id){
		var marquee = document.querySelector("#"+id);	
		marquee.onmouseover = function(){
			clearInterval(timer);
		};
		marquee.onmouseout = function(){
			autoPlay(id);	
		}
	},
	init = function(id){
		if(document.querySelector("#"+id+" span")){
			document.querySelector("#"+id).style.left = "0px";
			autoPlay(id);
			//handler(id);
		}else{
			document.querySelector(".marquee_wrap").style.display = "none";	
		}
	}
	return { init : init }
})() 



/**
 * 列表上下滚动
 * @param {String} id [容器id]
 * @usage
 *		LENOVO.act.scrollList.init(id)
 */
LENOVO.namespace('LENOVO.act.scrollList');
LENOVO.act.scrollList = (function(){
	var
	timer = null,
	autoPlay = function(id){
		var scrollList = document.querySelector("#"+id),
		scrollListCon = scrollList.querySelectorAll("div.scrollList_con"),
		scrollListHeight = scrollListCon[0].offsetHeight,
		wrapHeight = document.querySelector("div.scrollList_wrap").offsetHeight,
		top;
		scrollList.style.height = scrollListHeight*2 + "px";
		scrollListCon[1].innerHTML = scrollListCon[0].innerHTML;
		scrollList.style.top = "0px";
		timer = setInterval(function(){
			top = parseInt(scrollList.style.top);
			scrollList.style.top = (top - 1) + "px";
			if(Math.abs(top)>scrollListHeight+wrapHeight){
				scrollList.appendChild(scrollListCon[0]);
				scrollList.style.top = "0px";
			}
		},30);
	},
	handler = function(id){
		var scrollList = document.querySelector("#"+id);	
		scrollList.onmouseover = function(){
			clearInterval(timer);
		};
		scrollList.onmouseout = function(){
			autoPlay(id);	
		}
	},
	init = function(id){
		if(document.querySelector("#"+id+" span")){
			document.querySelector("#"+id).style.top = "0px";
			autoPlay(id);
			//handler(id);
		}else{
			document.querySelector(".scrollList_wrap").style.display = "none";	
		}
	}
	return { init : init }
})() 



/**
 * 刮刮卡
 * @param {Object} obj
 * @usage
 *		LENOVO.act.scratch.init({
 *	 		id : id,
 *			per : 刮开面积的临界百分值(0-100)
 *			callback : 到达临界值后的回调函数
 *		})
 */
LENOVO.namespace('LENOVO.act.scratch');
LENOVO.act.scratch = (function(){
	var
	ctx,
	card = function(id,per,callback){       
		          
		var canvas = document.querySelector('#'+id),
		w = canvas.offsetWidth,
		h = canvas.offsetHeight;
		
		canvas.width = w;             
		canvas.height = h;  
		document.body.style.mozUserSelect = 'none';         
		document.body.style.webkitUserSelect = 'none'; 
		 
		var        
		mousedown = false,
		bBtn = true,
		startBtn = true,
		layer = function(ctx){                 
			ctx.fillStyle = 'gray';
			ctx.fillRect(0, 0, w, h);             
		},
		eventDown = function(e){ 
			e.preventDefault();                 
			mousedown=true;             
		},  
		eventUp = function(e){                 
			e.preventDefault();                 
			mousedown=false;             
		},             
		eventMove = function(e){                 
			e.preventDefault();                 
			if(mousedown){                     
				if(e.changedTouches){                         
					e=e.changedTouches[e.changedTouches.length-1];                     
				}
				var canvas = document.querySelector('#'+id); 
				var offsetTop = function( elements ){ 
					var top = elements.offsetTop; 
					var parent = elements.offsetParent; 
					while( parent != null ){ 
						top += parent.offsetTop; 
						parent = parent.offsetParent; 
					}; 
					return top; 
				}; 
				var offsetLeft = function( elements ){ 
					var left = elements.offsetLeft; 
					var parent = elements.offsetParent; 
					while( parent != null ){ 
						left += parent.offsetLeft; 
						parent = parent.offsetParent; 
					}; 
					return left; 
				};
				var offsetX = offsetLeft(canvas), offsetY = offsetTop(canvas);                   
				var x = (e.pageX + document.documentElement.scrollLeft || document.body.scrollLeft) - offsetX || 0,                         
				y = (e.pageY + document.documentElement.scrollTop || document.body.scrollTop) - offsetY || 0;  
				//console.log(x+" "+y); 
				var ran = Math.floor(Math.random() * 2);
				canvas.style.marginRight = ran+'px';                  
				with(ctx){                    
					beginPath();                   
					arc(x, y, 12, 0, Math.PI * 2);
					fillStyle = '#fff';                         
					fill();                     
				};
				var cur_per = getTransparentPercent(ctx,w,h);
				//console.log(cur_per);
				if(typeof(per)!="undefined" && typeof(callback)!="undefined"){
					if(cur_per>per && bBtn==true){
						callback();	
						bBtn = false;
					}
				}
			}             
		},
		getTransparentPercent = function(ctx, w, h) {
			var imgData = ctx.getImageData(0, 0, w, h),
				pixles = imgData.data,
				transPixs = [];
			for (var i = 0, j = pixles.length; i < j; i += 4) {
				var a = pixles[i + 3];
				if (a < 128) {
					transPixs.push(i);
				}
			}
			return (transPixs.length / (pixles.length / 4) * 100).toFixed(2);
		},
		handler = function(id){
			var canvas = document.querySelector('#'+id);
			canvas.addEventListener('touchstart', eventDown);             
			canvas.addEventListener('touchend', eventUp);             
			canvas.addEventListener('touchmove', eventMove);             
			canvas.addEventListener('mousedown', eventDown);             
			canvas.addEventListener('mouseup', eventUp);             
			canvas.addEventListener('mousemove', eventMove);
		}; 
		
		
		ctx = canvas.getContext('2d');
		ctx.fillStyle='transparent';             
		ctx.fillRect(0, 0, w, h);     
		layer(ctx); 
		handler(id);         
		ctx.globalCompositeOperation = 'destination-out'; 
		         
	},
	
	init = function(obj){
		card(obj.id,obj.per,obj.callback);
	};
	return {init: init};

})();



//下载列表
LENOVO.namespace('LENOVO.act.list');
LENOVO.act.list = (function(){
	var 
	ulNode = document.querySelector('ul.app_list'),
	changeBtn = document.querySelector("#changeBtn"),
	bBtn=true,
	initData = function(){
		LENOVO.com.ajax.get('index.do','t='+new Date().getTime(), {"clientid":getclientid()}, function(_resp){
			renderList(_resp.appList);
			manageList();
		});
	},
	get = function(){
		if(bBtn==true){
			bBtn = false;
			LENOVO.com.ajax.get('nextAppListGroup.do','t='+new Date().getTime(), {"clientid":getclientid()}, function(_resp){
				bBtn = true;
				if(_resp.ret==true){
					renderList(_resp.appList);
					manageList();
					checkDownload();
				}
			});
		}
	},
	
	//列表渲染
	renderList = function(_data){
		var i, len = _data.length, 
			str = '';
		for(i=0; i<len; i+=1){
			if(_data[i].icon.indexOf('/')==0){
				_data[i].icon = _data[i].icon.substring(1);	
			}
			str +=
			'<li>\
				<a name="' +_data[i].appName+ '" iu="/' +_data[i].icon+ '" pn="'+_data[i].pkgName+'" vc="'+String(_data[i].versionCode)+'" lcaid="'+_data[i].lcaid+'">\
					<img src="http://img.lenovomm.com/'+_data[i].icon+'" />'+
					(function(){
						return _data[i].selected ? '<span class="selected">'+_data[i].appName+'</span>' : '<span>'+_data[i].appName+'</span>'
					})()
				+'</a>\
			</li>';
		}

		ulNode.innerHTML = str;
	},
	//列表事件管理
	manageList = function(){
		
		var btns = ulNode.querySelectorAll('li a'),
			i, 
			len = btns.length;
		for(i=0; i<len; i++){
			(function(i){
				btns[i].addEventListener('click',function(){
					var packageName = this.getAttribute('pn'), versionCode = this.getAttribute('vc'),
						name = this.getAttribute('name'), iconurl = this.getAttribute('iu'),
						lcaid = this.getAttribute('lcaid'),
						downloadurl = 'http://www.lenovomm.com/appstore/shortlink/'+lcaid;
						
						btns[i].querySelector("span").className = 'selected';
						var loaded = App5.getApp5Status(packageName,versionCode);
						if(loaded === 'download' || loaded === 'update'){
							global.startDownload(packageName,versionCode,downloadurl,name,iconurl);
						}else{
							App5.showToast('亲，您已经有该应用了，换一个应用下载哦');
						}
					
						for(var j=0;j<len;j++){
							btns[j].parentNode.className = "";	
						}
						btns[i].parentNode.className = "active";
				});
			})(i)
		}
	},
	//换一组
	changeList = function(){
		changeBtn.addEventListener("click",function(){
			get();
		},false);
	},
	//检查是否下载完正在安装
	checkDownload = function(){
		var 
		timer,
		i,
		status,
		pn,
		vc,
		lcaid,
		btns = ulNode.querySelectorAll('li a'),
		len = btns.length;
		timer = setInterval(function(){
			for(i=0;i<len;i++){
				pn = btns[i].getAttribute('pn');
				vc = btns[i].getAttribute('vc');
				lcaid = btns[i].getAttribute('lcaid');
				status = global.getApp5Status(pn, vc);
				if(status == 'installing'){
					LENOVO.com.ajax.get('downloadApp.do','lcaid='+lcaid, {"clientid":getclientid()}, function(data){
						if(data.ret==true){
							_hmt.push(['_trackEvent', "526活动", "下载", name]);
							cardNumChange(data.userGuaGuaCardNum);
						}else{
							showToast(data.msg);	
						}
					});
				}
			}
		},1000);	
	},
	
	init = function(){
		initData();
		changeList();
	};
	
	
	return {
		init:init
	}	
})();


//按钮初始化和积分变化逻辑
LENOVO.namespace('LENOVO.act.entrance');
LENOVO.act.entrance = (function(){
	var 
	entrance = document.querySelector("#entrance"),
	prize_entrance = document.querySelector("#prize_entrance"),
	everydayScore = document.querySelector("#everydayScore"),
	getCardBox = document.querySelector("#getCardBox"),
	shareBox = document.querySelector("#shareBox"),
	score = myData.score,
	prizeNum = myData.prizeNum,
	hardworkingBtn = myData.hardworkingBtn,
	shareToFriendBtn = myData.shareToFriendBtn,
	initBtn = function(){
		if(myData.userSecondKillMinScore>0){
			entrance.innerHTML = '<span class="btn_grey">查看详情</span>';
		}else{
			entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';	
		}
		//showToast(prizeNum);
		if(prizeNum>0){
			prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';	
		}else{
			prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';
		}
		//每天领积分
		if(!hardworkingBtn){
			everydayScore.innerHTML = '<span class="btn_grey">已领取</a>';
		}
		//分享微信
		if(!shareToFriendBtn){
			shareBox.innerHTML = '<span class="btn_grey">已分享</a>';
		}
	}
	change = function(){
		if(score<10){
			entrance.innerHTML = '<span class="btn_grey">查看详情</span>';
		}else{
			entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';	
		}
		if(prizeNum>0){
			prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';	
		}else{
			prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';
		}
	},
	init = function(){
		initBtn();
	}
	return {
		init:init,
		change:change
	}	
})()



//刮刮卡逻辑
LENOVO.namespace('LENOVO.act.scratchLogic');
LENOVO.act.scratchLogic = (function(){
	var 
	cardCanvas = document.querySelector("#scratch_card"),
	againBtn = document.querySelector(".scratch_again"),
	scratch_start = document.querySelector("#scratch_start"),
	scratch_end = document.querySelector("#scratch_end"),
	card_txt = document.querySelector("#card_txt"),
	scoreOnCard = 0,
	bBtn = true,
	first,
	
	touchStart = function(){
		var eventAjax = function(){
			if(bBtn){
				bBtn = false;
				var url = 'winScoreByGuaGuaCard.do',
				param = 't='+new Date().getTime();
				LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
					if(data.ret==true){
						card_txt.innerHTML = data.scoreOnCard + '分';
						scoreOnCard = data.scoreOnCard;
						cardNumChange(data.userGuaGuaCardNum);
						first = data.winnedScoreByGuaGuaCard;
					}else{
						showToast(data.msg);
					}
				});
			}
		};
		cardCanvas.addEventListener('touchstart', eventAjax);             
		cardCanvas.addEventListener('mousedown', eventAjax);
	},
	scratchInit = function(){
		LENOVO.act.scratch.init({
			id:"scratch_card",
			per:30,
			callback:function(){
				//第一次刮卡弹出分享弹窗
				/*if(!first){
					LENOVO.win.pop.init(3);
					first = true;
				}*/
				
				var url = 'getUserScoreLatestInfo.do',
				param = 't='+new Date().getTime();
				LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
					if(data.ret==true){
						//scoreChange(data.userScore);
						var userSecondKillMinScore = document.querySelector("#userSecondKillMinScore");
						var prize_entrance = document.querySelector("#prize_entrance");
						var entrance = document.querySelector("#entrance");
						LENOVO.act.score.init(data.userScore,data.prizeNumToExchange);
						if(userSecondKillMinScore.innerHTML - scoreOnCard>0){
							userSecondKillMinScore.innerHTML = userSecondKillMinScore.innerHTML - scoreOnCard;
						}else{
							userSecondKillMinScore.innerHTML = 0;
							ms_box.style.display = 'none';
						}
						if(data.prizeNumToExchange>0){
							prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';	
						}else{
							prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';
						}
						if(data.userSecondKillMinScore>0){
							entrance.innerHTML = '<span class="btn_grey">查看详情</span>';
						}else{
							entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';	
						}
						againBtn.style.display = "block";
					}else{
						showToast(data.msg);	
					}
				});
				
			}
		});
	},
	initData = function(){
		if(myData.cardNum>0){
			scratch_start.style.display = "block";
			scratch_end.style.display = "none";
			scratchInit();
		}else{
			scratch_start.style.display = "none";
			scratch_end.style.display = "block";
			card_txt.innerHTML = "";
		}
	},
	again = function(){
		document.querySelector(".scratch_again a").addEventListener("click",function(){
			initData();
			bBtn = true;
			card_txt.innerHTML = "";
			againBtn.style.display = "none";
		},false);	
	},
	init = function(){
		touchStart();
		initData();
		again();
	}
	return {init:init}
})()


//积分和兑换奖品数逻辑
//LENOVO.act.score.init(num1,num2)
LENOVO.namespace('LENOVO.act.score');
LENOVO.act.score = (function(){
	var
	score = document.querySelector("#score"),
	prizeType = document.querySelector("#prizeType"),
	init = function(num1,num2){
		score.innerHTML = num1;
		prizeType.innerHTML = num2;
		myData.score = num1;
		//LENOVO.act.initail.init();
	};
	return {init:init}	
})()



//微博分享
/**
 * 微博分享字数计算
 * @param {String}
 * @param {Number}
 * @param {Function}
 * @usage
 *	LENOVO.act.weibo.init(txtAreaId,maxlen,fn)
 */
LENOVO.namespace('LENOVO.act.weibo');
LENOVO.act.weibo = (function(){
	var 
	strfn = {
		byteLength : function(str) {
			if (typeof str == "undefined") {
				return 0
			}
			var aMatch = str.match(/[^\x00-\x80]/g);
			return (str.length + (!aMatch ? 0: aMatch.length))
		},
		trimHead : function(str) {
			return str.replace(/^(\u3000|\s|\t)*/gi, "")
		},
		trimTail : function(str) {
			return str.replace(/(\u3000|\s|\t)*$/gi, "")
		},
		trim : function(str) {
			return this.trimHead(this.trimTail(str))
		}
	},
	
	wordsCalc = function(txtAreaId,maxlen,fn) {
		var 
		$E = function(sel){return document.querySelector(sel)},
		txtArea = $E("#"+txtAreaId),
		num = Math.ceil(strfn.byteLength(strfn.trim(txtArea.value)) / 2);
		if(txtArea.value==""){
			showToast("您还没有输入内容");
			return false;	
		}
		if (num > maxlen/2) {
			showToast("您输入的字数超过限制");
			return false;
		} else {
			var url = 'blessAppStore.do',
			param = "content="+txtArea.value;
			LENOVO.com.ajax.post(url,param,{"clientid":getclientid()},function(data){
				if(data.ret==true){
					var content = txtArea.value;
					if(content.indexOf("@乐商店")==-1){
						content += " @乐商店";
					}
					share(content);
					cardNumChange(data.userGuaGuaCardNum);
					if(fn){
						fn();
					}
				}else{
					showToast(data.msg);	
				}
			});
			
		}
	},
	
	checkchar = function(txtAreaId,maxlen,fn){	
		setTimeout(function() {
			document.querySelector("#"+txtAreaId).focus();			
			wordsCalc(txtAreaId,maxlen,fn);
		},100)
	},
	
	share = function(title){
		var url = "http://service.weibo.com/share/share.php?url=&title="+title+"&appkey=1343713053";
		window.location.href = url;	
	},
	
	init = function(txtAreaId,maxlen,fn){
		checkchar(txtAreaId,maxlen,fn);
	};
	return {init: init};
})()

//改变刮刮卡数量
function cardNumChange(num){
	myData.cardNum = num;
	document.querySelector("#cardNum").innerHTML = num;
}

//改变积分数
function scoreChange(score){
	myData.score = score;
	document.querySelector("#score").innerHTML = score;
}

//分享到微博
function shareweibo(){
	LENOVO.act.weibo.init("weibo_txt",270);	
}


//每天领取积分
function getOneScore(){
	var 
	url = 'winHardworkingScore.do',
	param = '',
	everydayScore = document.querySelector("#everydayScore");
	LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
		if(data.ret==true){
			scoreChange(data.userScore);
			everydayScore.innerHTML = '<span class="btn_grey">已领取</span>';
			
			var userSecondKillMinScore = document.querySelector("#userSecondKillMinScore");
			var prize_entrance = document.querySelector("#prize_entrance");
			var entrance = document.querySelector("#entrance");
			var ms_box = document.querySelector("#ms_box");
			document.querySelector("#prizeType").innerHTML = data.prizeNumToExchange;
			if(userSecondKillMinScore.innerHTML - 1>0){
				userSecondKillMinScore.innerHTML = userSecondKillMinScore.innerHTML - 1;
				entrance.innerHTML = '<span class="btn_grey">查看详情</span>';
			}else{
				entrance.innerHTML = '<a class="btn" href="activity.htm">查看详情</a>';
				userSecondKillMinScore.innerHTML = 0;
				ms_box.style.display = 'none';
			}
			if(data.prizeNumToExchange>0){
				prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';	
			}else{
				prize_entrance.innerHTML = '<a class="btn" href="prize.htm">我要兑奖</a>';
			}
			
		}else{
			showToast(data.msg);		
		}
	});
}

//兑换刮刮卡
function getCard(){
	var
	verify_code = document.querySelector("#verify_code").value,
	cardNum = document.querySelector("#cardNum"),
	getCardBox = document.querySelector("#getCardBox"),
	url = 'winGuaGuaCardByVerifyCode.do',
	param = 'vc='+verify_code;
	LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
		if(data.ret==true){
			cardNum.innerHTML = data.userGuaGuaCardNum;
			myData.cardNum = data.userGuaGuaCardNum;
			//getCardBox.innerHTML = '<span class="btn_grey">已兑换</span>';
			LENOVO.act.scratchLogic.init();
		}else{
			showToast(data.msg);
		}
	});
}

//分享弹窗
function sharebtn(){
	LENOVO.win.pop.init(3);	
}

//分享到微信
function shareweixin(){
	var 
	url = 'shareToFriend.do',
	param = '',
	shareBox = document.querySelector("#shareBox");
	LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
		if(data.ret==true){
			if(global && typeof(global.share)!="undefined"){
				var 
				title = '乐商店四周年，大奖乐翻天！',
				content = '验证码：'+data.verifyCode+'。你的好友邀请你参加乐商店四周年庆有奖活动，请在2小时内进入手机版乐商店APP活动页面，至刮刮卡区兑换刮刮卡。',
				mimetype = 'text/plain',
				streamUrl = ''; 
				//cardNumChange(data.userGuaGuaCardNum);
				closePop();
				global.share(title,content,mimetype,streamUrl);
			}else{
				document.querySelector("#share_btn_box").innerHTML = '<a class="btn" onClick="closePop()">取消</a><a class="btn" onclick="lestoreapp()">升级</a>';
				showToast('该版本不支持分享，请升级乐商店客户端');	
			}
		}else{
			closePop();
			showToast(data.msg);	
		}
	});	
}

//争当大boss的app下载
function appdownload(){
	if(global){
		var packageName = 'com.mbg.lenovogame',
		versionCode = '1.0',
		downloadurl = 'http://www.lenovomm.com/appstore/shortlink/14414666',
		name = '联想奋斗史',
		iconurl = 'http://img.lenovomm.com/crawler@cluster-1/ams/fileman/img/icon/2014-04-28095612-_1398650172165_9684.png?isCompress=true&width=75&height=75&quantity=0.8&from=3gw';
		global.startDownload(packageName,versionCode,downloadurl,name,iconurl);	
	}
}

//最新版乐商店的app下载
function lestoreapp(){
	if(global){
		var packageName = 'com.lenovo.leos.appstore',
		versionCode = '60910',
		downloadurl = 'http://www.lenovomm.com/appstore/shortlink/14716755',
		name = '乐商店',
		iconurl = 'http://img.lenovomm.com/crawler@cluster-1/ams/fileman/img/icon/2014-05-21100237-_1400680957981_8905.png';
		global.startDownload(packageName,versionCode,downloadurl,name,iconurl);	
	}	
}