(function(WIN, U, E){

	var App={
		albumUrl:'/video/api/albumlist?lt=channel'
		,filterUrl:'/video/api/filters'
		,doms:{top:'#topBox', ctn:'#ctnBox', filterPathBox:'#filterPathBox', filterBox:'#filterBox',filterBody:'#filterBody', filterFooter:'#filterFooter',  btnFilterCancel:'#btnFilterCancel', btnFilterCfm:'#btnFilterCfm', btnFilter:'#btnFilter'}
		,clsFilterOn:'on', attrType:'filter-type'
		,vlist:null, filterTpl:null, filterItTpl:null, filterPathTpl:null
		,dataNav:null
		,filterData:[]//1:type; 2: area; 3:date
		,init:function(){
			var doms=this.doms;
			U.initDoms(doms);
			doms.ctn.height($(WIN).height()-doms.top.height());

			this.filterTpl=$(doms.filterBody.children()[0]).remove();
			this.filterItTpl=$(this.filterTpl.find('.filterBlock-list').children()[0]).remove();
			this.filterPathTpl=$(doms.filterPathBox.children()[0]).remove();

			var t=this;
			doms.btnFilter.click(function(){
				t.showFilter();
			});
			doms.btnFilterCancel.click(function(){doms.filterBox.hide();});
			doms.btnFilterCfm.click(function(){
				t.getFilterPath();
				doms.filterBox.hide();
				t.reloadAlbum();
			});

			this.code=U.getURLParam('code');
			if(this.code){
				var tpl=$(doms.ctn.children()[0]).remove().removeClass(E.clsTpl);
				this.vlist=new U.VList(doms.ctn, tpl, this.albumUrl, this.getArgs()
					,function(d){
						if(d&&d.data){
							document.title=d.data.name;
							return d.data.dataList;
						}
					}
				);
				WIN.setTimeout(function(){t.loadFilter();}, 100);
			}else{
				T.show('网址有误');
			}
		}
		,showFilter:function(){
			this.showFilter=function(){
				this.doms.filterBox.show();
			}
			this.showFilter();
			this.doms.filterBody.height($(WIN).height()-this.doms.filterFooter.height());
		}
		,getFilterPath:function(){
			var b=this.doms.filterPathBox, d=this.filterData;
			var c=document.createDocumentFragment();
			for(var i=0, len=d.length; i<len; i++){
				if(!d[i].code)continue;
				var it=this.filterPathTpl.clone();
				it.html(d[i].name);
				c.appendChild(it[0]);
			}
			if(!c.childNodes.length){
				var it=this.filterPathTpl.clone();
				it.html('全部');
				c.appendChild(it[0]);
			}
			b.empty().append(c);
		}
		,selectFilter:function(ev){
			var ix=parseInt(ev.currentTarget.getAttribute(this.attrType));
			if(this.filterData[ix-1]){
				this.filterData[ix-1].dom.removeClass(this.clsFilterOn);
			}
			this.filterData[ix-1]=ev.target.data;
			this.filterData[ix-1].dom.addClass(this.clsFilterOn);
		}
		,loadFilter:function(){
			var t=this;
			$.getJSON(this.filterUrl, {code:this.code}, t.doms.filterPathBox, function(d){
				if(d.data&&d.data.length){
					t.renderFilter(d.data);
					t.getFilterPath();
				}
			});
		}
		,reloadAlbum:function(){
			this.vlist.args=this.getArgs();
			this.vlist.reload();
		}
		,getArgs:function(){
			var fd=this.filterData;
			return {
				code:this.code 
				,typeCode:fd[0]&&fd[0].code
				,areaCode:fd[1]&&fd[1].code
				,dateCode:fd[2]&&fd[2].code
			};
		}
		,renderFilter:function(data){
			var c=document.createDocumentFragment();
			for(var i=0, len=data.length; i<len; i++){
				var it=this.filterTpl.clone(), d=data[i];
				it.find('.filterBlock-tit').html(d.name);
				var b=it.find('.filterBlock-list');
				var t=this;
				b.click(function(ev){t.selectFilter(ev);});
				b.attr(this.attrType, d.type);
				d=d.subs;
				if(d){
					for(var j=0, len2=d.length; j<len2; j++){
						var it2=this.filterItTpl.clone();
						it2[0].data=d[j];
						d[j].dom=it2;
						it2.html(d[j].name);
						b.append(it2);
						if(d[j].code=='all')d[j].code='';
						if(!j){
							it2.addClass(this.clsFilterOn);
							this.filterData[i]=d[j];
						}
					}
				}
				c.appendChild(it[0]);
			}
			this.doms.filterBody.append(c);
		}
	};

	$(function(){
		App.init();
	});
})(window, LENOVO.util, LENOVO.enum);
