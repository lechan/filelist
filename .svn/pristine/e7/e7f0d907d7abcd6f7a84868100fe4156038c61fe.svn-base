define(["app/tool","app/dialog","app/toast","app/lazyload","lib/swipe","lib/fastclick"],function(t,dialog,toast,lazy) {
	"use strict";
	var App = {
		config : {
			indexUrl : 'MOCK/index.json'+'?t='+new Date().getTime(),
			loginUrl : ''+'?t='+new Date().getTime(),
			countdownUrl : 'MOCK/countdown.json'+'?t='+new Date().getTime()
		},
		tpl : {
			userCon : '<div id="user" class="user"></div>',
			lvCon : '<div id="lv" class="lv"></div>',
			bannerCon : '\
			<div id="banner" class="banner">\
				<div class="banner_wrap"></div>\
				<div class="banner_dot_wrap"></div>\
			</div>',
			tagCon : '<div id="tag" class="tag"><ul></ul></div>',
			topicCon : '<div class="topicItem"></div>',
			user : '\
			<div class="fl">\
				<div class="username"><i>LV#{level}</i>#{userName}</div>\
				<div class="score">#{userScore}</div>\
			</div>\
			<div class="fr">\
				<ul class="userBtn">\
					<li>\
						<a>\
							<div class="icon1"></div>\
							<h2>订单</h2>\
						</a>\
					</li>\
					<li>\
						<a>\
							<div class="icon2"></div>\
							<h2>收藏</h2>\
						</a>\
					</li>\
					<li>\
						<a>\
							<div class="icon3"><i class="notice"></i></div>\
							<h2>消息</h2>\
						</a>\
					</li>\
				</ul>\
			</div>',
			lv : '\
			<div class="lv_left lv_border_right"><a href="#{href1}"><img src="#{imgUrl1}" /></a></div>\
			<div class="lv_right lv_border_left">\
				<div class="lv_top lv_border_bottom">\
					<a href="#{href2}"><img src="#{imgUrl2}" /></a>\
				</div>\
				<div class="lv_bottom lv_border_top">\
					<div class="lv_bottom_item lv_border_right"><a href="#{href3}"><img src="#{imgUrl3}" /></a></div>\
					<div class="lv_bottom_item lv_border_left"><a href="#{href4}"><img src="#{imgUrl4}" /></a></div>\
				</div>\
			</div>',
			bannerItem : '<div><a href="#{url}"><img src="#{imgUrl}" /></a></div>',
			bannerDotItem : '<i></i>',
			tagItem : '<li><a href="#{url}"><h2>#{name}</h2><div class="listImg"><img src="images/grey.png" class="lazy" dataimg="#{imgUrl}" /></div></a></li>',
			topicItem : '\
			<h2>\
				<span class="fl">#{name}</span>\
				<span class="fr">#{more}</span>\
			</h2>\
			<ul class="listWrap">#{list}</ul>\
			',
			listItem : '\
			<li>\
            	<a href="#{url}">\
                	#{topItem}\
                    <div class="listImg"><img class="lazy" dataimg="#{iconAddr}" src="images/grey.png" /></div>\
                    <h3>#{name}</h3>\
                    <h4><strong>#{scorePrice}</strong><i>#{promotionWords}</i></h4>\
                    #{bottomItem}\
                </a>\
            </li>\
			',
			listItemType : [{
				"isCountdown" : true,
				"topItem" : '<div class="countdown" id="countdown#{num}"><i>00</i>:<i>00</i>:<i>00</i></div>',
				"bottomItem" : '<div class="bottomTxt1">仅剩#{remainAmount}件</div>'	
			},{
				"topItem" : '',
				"bottomItem" : ''	
			},{
				"topItem" : '',
				"bottomItem" : '<div class="bottomTxt1">仅剩#{remainAmount}件</div>'	
			},{
				"topItem" : '<div class="rank">HOT</div>',
				"bottomItem" : '<div class="bottomTxt2"><strong>#{saleAmount}</strong>已兑</div>'	
			}],
			more : '<a class="more" href="#{moreUrl}"></a>',
			popbox : {
				"test" : '\
				<section class="pop_wrap">\
					<h2 style="padding:20px 0px;">测试弹窗</h2>\
				</section>'	
			}
		},
		getData : function(){
			var self = this;
			$.ajax({
				url:self.config.indexUrl,
				type:"GET",
				dataType:"json",
				success: function(data){
					self.data = data;
					self.renderMainCon();
				},
				error: function(){
					alert("数据错误");	
				}	
			});	
		},
		renderMainCon : function(){
			var self = this,i,topicNum = self.data.normalTopics.length;
			$("#mainPage").append(self.tpl.userCon).append(self.tpl.lvCon);
			for(i=0;i<topicNum;i++){
				$("#mainPage").append(self.tpl.topicCon);
				self.topicItem(i);	
			}
			$(self.tpl.bannerCon).insertBefore($("#mainPage div.topicItem").eq(1));
			$(self.tpl.tagCon).insertBefore($("#mainPage div.topicItem").eq(1));
			
			self.user();
			self.lv();
			self.banner();
			self.tag();
			self.countdownHandler();
			lazy.init();
		},
		user : function(){
			var
			self = this,
			render = function(){
				var userHtml = '';
				var obj = {
					"level" : 3,
					"userName" : "用户名",
					"userScore" : 234	
				};
				userHtml = t.formatTpl(self.tpl.user,{},obj);
				$("#user").html(userHtml);
			},
			init = function(){
				render();
			}
			init();	
		},
		lv: function(){
			var
			self = this,
			render = function(){
				var lvData = self.data.lvTopics;
				var lvHtml = '';
				var map = [{"url":"href1","img":"imgUrl1"},{"url":"href2","img":"imgUrl2"},{"url":"href3","img":"imgUrl3"},{"url":"href4","img":"imgUrl4"}];
				var obj = {};
				$.each(lvData,function(index){
					obj[map[index]["url"]] = lvData[index]["moreUrl"];
					obj[map[index]["img"]] = lvData[index]["imgUrl"];
				});
				lvHtml = t.formatTpl(self.tpl.lv,{},obj);
				$("#lv").html(lvHtml);
			},
			init = function(){
				render();
			}
			init();	
		},
		banner : function(){
			var
			self = this,
			render = function(){
				var bannerData = self.data.banners;
				var bannerList = '';
				var bannerDotList = '';
				$.each(bannerData,function(index){
					bannerList += t.formatTpl(self.tpl.bannerItem,{},bannerData[index]);
					bannerDotList += t.formatTpl(self.tpl.bannerDotItem,{},{});	
				});
				$(".banner_wrap").html(bannerList);
				$(".banner_dot_wrap").html(bannerDotList).find("i").eq(0).addClass("active");
				
				handler();
			},
			handler = function(){
				var bannerObj = document.getElementById("banner");
				var bannerSwipe = Swipe(bannerObj, {
					startSlide: 0,
					auto: 5000,
					continuous: true,
					disableScroll: false,
					stopPropagation: true,
					callback: function(index, element) {},
					transitionEnd: function(index, element) {
						$(".banner_dot_wrap i").removeClass("active");
						$(".banner_dot_wrap i").eq(index).addClass("active");
					}
				});	
			},
			init = function(){
				render();
			}
			init();
		},
		tag : function(){
			var
			self = this,
			render = function(){
				var tagData = self.data.tags;
				var tagList = '';
				$.each(tagData,function(index){
					tagList += t.formatTpl(self.tpl.tagItem,{},tagData[index]);
				});
				$("#tag ul").html(tagList);
			},
			init = function(){
				render();
			}
			init();	
		},
		countdownTimeArr : [],
		topicItem : function(index){
			var
			self = this,
			render = function(index){
				var topicData = self.data.normalTopics[index];
				var listData = self.data.normalTopics[index]["list"];
				var topicHtml = '';
				var topicList = '';
				var topItem;
				var bottomItem;
				var more = self.data.normalTopics[index]["moreUrl"];
				var 
				more = more == "" ? "" : 
				(function(){
					return t.formatTpl(self.tpl.more,{},{"moreUrl" : more});
				})();
				$.each(listData,function(listIndex){
					topItem = function(){return t.formatTpl(self.tpl.listItemType[index]["topItem"],{"num":function(){return listIndex+1}},listData[listIndex])};
					bottomItem = function(){return t.formatTpl(self.tpl.listItemType[index]["bottomItem"],{},listData[listIndex])};
					topicList += t.formatTpl(self.tpl.listItem,{
						"topItem" : topItem,
						"bottomItem" : bottomItem
					},listData[listIndex]);
					if(self.tpl.listItemType[index]["isCountdown"]){
						self.countdownTimeArr.push(listData[listIndex]["endTime"]);	
					}
				});
				topicHtml = t.formatTpl(self.tpl.topicItem,{},{
					"name" : topicData["name"],
					"more" : more, 
					"list" : topicList	
				});
				$(".topicItem").eq(index).html(topicHtml);
			},
			init = function(index){
				render(index);
			}
			init(index);		
		},
		countdownList : function(){
			var
			self = this,
			render = function(){
				var listData = self.countdownData["list"];
				var topicList = '';
				var topItem;
				var bottomItem;
				$.each(listData,function(listIndex){
					topItem = function(){return t.formatTpl(self.tpl.listItemType[0]["topItem"],{"num":function(){return listIndex+1}},listData[listIndex])};
					bottomItem = function(){return t.formatTpl(self.tpl.listItemType[0]["bottomItem"],{},listData[listIndex])};
					topicList += t.formatTpl(self.tpl.listItem,{
						"topItem" : topItem,
						"bottomItem" : bottomItem
					},listData[listIndex]);
					self.countdownTimeArr.push(listData[listIndex]["endTime"]);	
				});
				$(".topicItem").eq(0).find(".listWrap").html(topicList);
			},
			init = function(){
				render();
			}
			init();
		},
		countdownHandler : function(){
			var self = this,i,len = self.countdownTimeArr.length;
			if(len!=0){
				for(i=0;i<len;i++){
					t.countdown.init('countdown'+(i+1),t.formatDate(self.countdownTimeArr[i],'yyyy/MM/dd hh:mm:ss'),function(){
						$.ajax({
							url:self.config.countdownUrl,
							type:"GET",
							dataType:"json",
							success: function(data){
								self.countdownData = data;
								self.countdownList();
							},
							error: function(){
								alert("数据错误");	
							}	
						});	
						self.countdownTimeArr = [];
					});
					
				}
			}
		},
		recommendList : function(){
			var myScroll = new IScroll('#recommend_wrapper', { scrollX: true, scrollY: false, eventPassthrough: true, preventDefault: false });	
		},
		init : function(){
			this.getData();
			dialog.ready();
			toast.ready();
			//dialog.open(this.tpl.popbox.test);
			$("#dialogWrapper").click(function(){
				dialog.close();
			});
			//toast.show("测试");
			console.log(t.formatDate('1437370000000','yyyy/MM/dd hh:mm:ss'));
			
		}
	}
		
	App.init();
	
	document.addEventListener('DOMContentLoaded', function() {
		FastClick.attach(document.body);
	}, false);
});