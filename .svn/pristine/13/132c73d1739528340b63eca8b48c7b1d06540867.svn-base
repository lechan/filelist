define(["app/tool","app/dialog","app/toast","app/cities"],function(t,dialog,toast) {
"use strict";
var config={
    getAddress:"../prize/getUserInfo.do",
    postAddress:"../prize/updateUserInfo.do",
    postAmsAddress:"../prize/updateAmsInfo.do",
//
//    giftDetail:"../testdata/giftdetail.html",  //
//    getAddress:"../testdata/address.html",
//    postAddress:"../testdata/postaddress.html",
    isPost:false
}

var address = (function(){
    var initPage=function(){
        if(t.getURLParam("gid")!="" && t.getURLParam("gid")!=0){
            loadGiftDetail("logId="+t.getURLParam("gid"));
            //document.title="编辑订单收货信息";
//        }else{
//            loadAddress();
        }
        bindEvent();
        //$_id("addrBot").style.height=(document.documentElement.clientHeight/2)+"px";
    },
    loadAddress=function(){
        ajax.get(config.getAddress,'stamp='+Date.parse(new Date()),{},function(res){
            setAddrData(res.info);
        },function(){
        })
    },
	$_id = function(_id){
		return document.getElementById(_id);
	},
    setAddrData=function(res){
        $("#name").val(res["userName"]);
        $("#tel").val(res["phoneNumber"]);
        $("#qq").val(res["qqNum"]);
        $("#province").val(res["province"]);
        $("#city").val(res["city"]);
        $("#county").val(res["region"]);

        $("#area").val(res["province"]+res["city"]+res["region"]);
        $("#areaTemp").val(res["province"]+","+res["city"]+","+res["region"]);

        $("#addr").val(res["address"]);
        $("#userId").val(res["userId"]);
    },
    setPushToFresh=function(){
    	if(document.getElementById("mask").style.display=="block"){
            window.lestore && window.lestore.togglePushToRefresh && window.lestore.togglePushToRefresh(false);
        }else{
            window.lestore && window.lestore.togglePushToRefresh && window.lestore.togglePushToRefresh(true);
        }
    },
    bindEvent=function(){
        document.querySelector("#area").addEventListener("click",function(e){
            $("#area").blur();
            var setCityData=function(_type){
                    var str="";
                    switch(_type){
                        case 0:
                            //$("#areaTemp").val("");
                            var city=area_data,
                                len=city.length,
                                pname=$("#province").val();
                            for(var i=1;i<len;i++){
                                str+='<li class="'+ (pname==city[i].name?"cur":"") +'" data-name="'+ city[i].name +'" data-sublen='+ (city[i].sub==undefined?0:city[i].sub.length) +'>'+ city[i].name +'<i class="icon icon-city"></i></li>';
                            }
                            break;
                        case 1:
                            var city=area_data,
                                len=city.length,
                                pname=$("#province").val();
                            for(var i=1;i<len;i++){
                                if(pname==city[i].name){
                                    var city=city[i].sub,
                                        len=city.length,
                                        name=$("#city").val();
                                    for(var i=1;i<len;i++){
                                        str+='<li class="'+ (name==city[i].name?"cur":"") +'" data-name="'+ city[i].name +'" data-sublen='+ (city[i].sub==undefined?0:city[i].sub.length) +'>'+ city[i].name +'<i class="icon icon-city"></i></li>';
                                    }
                                }
                            }
                            break;
                        case 2:
                            var city=area_data,
                                len=city.length,
                                pname=$("#province").val();
                            for(var i=1;i<len;i++){
                                if(pname==city[i].name){
                                    var city=city[i].sub,
                                        len=city.length,
                                        cityname=$("#city").val();
                                    for(var i=1;i<len;i++){
                                        if(cityname==city[i].name){
                                            var city=city[i].sub,
                                                len=city.length,
                                                name=$("#county").val();
                                            for(var i=1;i<len;i++){
                                                str+='<li class="'+ (name==city[i].name?"cur":"") +'" data-name="'+ city[i].name +'" data-sublen='+ (city[i].sub==undefined?0:city[i].sub.length) +'>'+ city[i].name +'<i class="icon icon-city"></i></li>';
                                            }
                                        }
                                    }
                                }
                            }
                            break;
                        default:
                            break;
                    }
                    $("#CityList").html(str);
                    setTimeout(function(){
                        bindEventCity(_type);
                    },300);
                },
                bindEventCity=function(_type){
                    var node=document.querySelectorAll("#CityList li");
                    for(var i= 0,l=node.length;i<l;i++){
                        (function(i,_type){
                            node[i].addEventListener("click",function(){
                                $("#CityList li").removeClass("cur");
								$(node[i]).addClass("cur");
                                var subLen=node[i].getAttribute("data-sublen");
                                var curValue=node[i].getAttribute("data-name");
                                switch(_type){
                                    case 0:
                                        $("#province").val(curValue);
                                        break;
                                    case 1:
                                        $("#city").val(curValue);
                                        break;
                                    case 2:
                                        $("#county").val(curValue);
                                        break;
                                    default:
                                        break;
                                }
                                if(subLen>0){
                                    setTimeout(function(){
                                        setCityData(++_type);
                                    },200);
                                }else{
                                	var newCityStr='';
                                	switch(_type){
	                                    case 0:
	                                        newCityStr=$("#province").val();
	                                        break;
	                                    case 1:
	                                        newCityStr=$("#province").val()+","+$("#city").val();
	                                        break;
	                                    case 2:
	                                        newCityStr=$("#province").val()+","+$("#city").val()+","+$("#county").val();
	                                        break;
	                                    default:
	                                        break;
	                                }
                                    $("#areaTemp").val(newCityStr);
                                    $("#area").val(newCityStr.replace(/\,/g,""));
                                    dialog.close();
                                    setPushToFresh();
                                }
                            },false);
                        })(i,_type);
                    }
                },
                setCityWrapHeight=function(){
                    var flag=10;
                    window.setCityWrapHeightTimer=setInterval(function(){
                        if(flag<=0){
                            window.clearInterval(window.setCityWrapHeightTimer);
                        }
                        flag--;
                        var dialogH=window.getComputedStyle($_id("dialogWrapper"),null).height;
                        var titH=window.getComputedStyle($_id("DialogCityTit"),null).height;
						$("#DialogCityCon").css("height",(parseFloat(dialogH)-parseFloat(titH))+"px");
                    },200)

                };
            var startStr =  '\
			<section class="pop_wrap">\
				<h2 class="dialogCityTit" id="DialogCityTit">请选择地区</h2>\
				<div class="dialogCon" id="DialogCityCon">\
					<ul class="cityList" id="CityList"></ul>\
				</div>\
			</section>';
			$("#dialogWrapper").css("height","90%");	
            dialog.open(startStr);
            setCityData(0);
            setCityWrapHeight();
            setPushToFresh();
            $_id('mask').addEventListener("click",function(){
            	window.lestore && window.lestore.togglePushToRefresh && window.lestore.togglePushToRefresh(true);
            });
        });

        document.querySelector("#SetDefaultAddr").addEventListener("click",function(e){
            if(e.target.id!="setDef"){
                if($_id("setDef").checked == true){
                    $_id("setDef").checked = false;
                }else{
                    $_id("setDef").checked = true;
                }
            }
        });

        config.isPost=false;
        document.querySelector("#SubmitAddr").addEventListener("click",function(e){
            address.submitForm();
        });
    },
    submitForm=function(){
        var userName=$("#name").val(),
            tel=$("#tel").val(),
            qq=$("#qq").val(),
            addr=$("#addr").val(),
            userId=$("#userId").val(),
            param="";
        if(userName==""){
            toast.show("请输入姓名。");
            $("#name").focus();
            return false;
        }else{
            param+="userName="+encodeURIComponent(userName);
        }
        if(tel==""){
            toast.show("请输入手机号码。");
            $("#tel").focus();
            return false;
        }else if(!(/^0?1\d{10}$/.test(tel))){
            //!(/^0?1[358]\d{9}$_id/.test(tel) || /^0?(\d{1,4}[-]?)?(\d{6,8})([-]?\d{1,4})$_id/.test(tel))
            toast.show("您输入的手机号码不合法，请核对。");
            $("#tel").focus();
            return false;
        }else{
            param+="&phoneNumber="+tel;
        }
        if(qq==""){
            toast.show("请输入QQ号码。");
            $("#qq").focus();
            return false;
        }else if(!/^\d{5,10}$/.test(qq)){
            toast.show("您输入的QQ号不合法，请核对。");
            $("#qq").focus();
            return false;
        }else{
            param+="&qqNum="+qq;
        }
        if($("#areaTemp").val()==""){
            toast.show("您选择收货地址。");
            return false;
        }else{
            var areaArray=$("#areaTemp").val().split(",");
            if(areaArray[0]==""){
                toast.show("您选择收货地址。");
                return false;
            }else{
                param+="&province="+encodeURIComponent(areaArray[0]);
                param+="&city="+encodeURIComponent(areaArray[1]);
                if(areaArray.length>2){
                	param+="&region="+encodeURIComponent(areaArray[2]);
                }else{
                	param+="&region=";
                }
                
            }
        }

        if(addr==""){
            toast.show("请输入详细收货地址。");
            $("#addr").focus();
            return false;
        }else{
            param+="&address="+encodeURIComponent(addr);
        }
        if(t.getURLParam("gid")!="" && t.getURLParam("gid")!=0){
            if($_id("setDef").checked){
                param+="&syncInfo=true";
            }else{
                param+="&syncInfo=false";
            }
        }else{
            param+="&syncInfo=true";
        }
        if(t.getURLParam("gid")!=""){
            param+="&logId="+t.getURLParam("gid");
        }else{
            param+="&logId=0";
        }
        param+="&userId="+userId;

        if(!config.isPost){
            config.isPost=true;
            setTimeout(function(){config.isPost=false;},11000);
            if(t.getURLParam("gid")!="" && t.getURLParam("gid")!=0){
                ajax.post(config.postAddress,param+'&stamp='+Date.parse(new Date()),{},function(res){
                    if(res.ret){
                        toast.show("恭喜，地址保存成功！");
                        if(t.getURLParam("backurl")!=""){
                            location.href=t.getURLParam("backurl");
                        }else{
                            location.href="mygift.html";
                        }
                    }else{
                        res.msg && toast.show(res.msg);
                    }
                    config.isPost=false;
                },function(){
                    config.isPost=false;
                })
            }else{
                ajax.post(config.postAmsAddress,param+'&stamp='+Date.parse(new Date()),{},function(res){
                    if(res.ret){

                        toast.show("恭喜，地址保存成功！");
                        if(t.getURLParam("backurl")!=""){
                            location.href=t.getURLParam("backurl");
                        }else{
                            location.href="mygift.html";
                        }
                    }else{
                        res.msg && toast.show(res.msg);
                    }
                    config.isPost=false;
                },function(){
                    config.isPost=false;
                })
            }
        }
    },
    submitArea=function (){
        var province=$_id("province").options[$_id("province").selectedIndex].text,
            city=$_id("city").options[$_id("city").selectedIndex].text,
            county=$_id("county").options[$_id("county").selectedIndex].text;
        if(province=="请选择"){
            toast.show("请选择省份");
            return false;
        }else if(city=="请选择"){
            toast.show("请选择城市");
            return false;
        }else if(county=="请选择"){
            toast.show("请选择区县");
            return false;
        }
        $("#area").val(province+" "+city+" "+county);
        dialog.close();
    };
    return {
        initPage:initPage,
        submitArea:submitArea,
        submitForm:submitForm
    };
})();

    dialog.ready();
	toast.ready();
	address.initPage();
    document.getElementById("name").focus();

    //back回调
    window.backevent=function(){
        if($("#UpdateStoreDialog")){
            return 0;
        }else{
            if(document.getElementById("mask").style.display=="block"){
                dialog.close();
                setTimeout(function(){
                	window.lestore && window.lestore.togglePushToRefresh && window.lestore.togglePushToRefresh(true);
                },200);                
                return 1;
            }else{
                return 0;
            }
        }
    }

    //对A520特殊处理
    var phoneModel=window.lestore && window.lestore.getPhoneModel().toLowerCase();
    if(phoneModel=="lenovo a520" || phoneModel=="lenovo a60"){
        var clientHeight=document.documentElement.clientHeight;
        function setBotBar(){
            var node=$_id("addrBtnWrap"),nodeH=window.getComputedStyle(node,null).height;
            node.style.position="absolute";
            node.style.top=(document.body.scrollTop+clientHeight-nodeH) +"px";
            node.style.left="0px";
        }
        window.addEventListener("scroll",setBotBar,false);
    }
	
});