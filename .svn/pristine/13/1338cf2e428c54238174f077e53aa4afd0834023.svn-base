define(["app/tool","app/lazyload","app/toast","lib/fastclick"],function(t,lazy,toast) {
	"use strict";
	var App = {
		loadingComplete : true,
		config : {
			listUrl : 'MOCK/order.json'+'?t='+new Date().getTime()
		},
		tpl : {
			listItem : '\
			<li class="#{islv}">\
                <a href="#{url}">\
                	#{lvIcon}\
                    <div class="listImg"><img class="lazy" dataimg="#{iconAddr}" src="images/grey.png"></div>\
                    <h3><span class="topicTag">#{topicTag}</span>#{name}</h3>\
                    <h4><strong>#{scorePrice}</strong></h4>\
                    #{lvTips}\
                    <h5>仅剩#{remainAmount}件</h5>\
                </a>\
            </li>\
			',
			popbox : {
				"test" : '\
				<section class="pop_wrap">\
					<h2 style="padding:20px 0px;">测试弹窗</h2>\
				</section>'	
			}
		},
		getListData : function(){
			var self = this;
			self.loadingComplete = false;
			$.ajax({
				url:self.config.listUrl,
				type:"GET",
				dataType:"json",
				success: function(data){
					self.data = data;
					if(self.data.merchs.length>0){
						//self.renderList();
					}
				},
				error: function(){
					alert("数据错误");	
				}	
			});	
		},
		renderList : function(){
			var self = this;
			var listData = self.data.merchs;
			var listHtml = '';
			var lvIcon,lvTips,topicTag;
			$.each(listData,function(index){
				lvIcon = t.formatTpl(self.tpl.lvIcon,{},{});
				lvTips = t.formatTpl(self.tpl.lvTips,{},listData[index]);
				topicTag = t.formatTpl(self.tpl.topicTag,{},listData[index]);
				listHtml += t.formatTpl(self.tpl.listItem,{
					"islv" : function(){return listData[index]["lv"] ? "lvItem" : ""},
					"lvIcon" : function(){return listData[index]["lv"] ? lvIcon : ""},
					"lvTips" : function(){return listData[index]["lv"] ? lvTips : ""},
					"topicTag" : function(){return listData[index]["topicName"] ? topicTag : ""}
				},listData[index]);
			});
			
			$(".orderList ul").append(listHtml);
			lazy.init();
			self.scrollList();	
			self.loadingComplete = true;
		},
		scrollList : function(){
			var self = this;
			//获取滚动条当前的位置 
			var getScrollTop = function() { 
				var scrollTop = 0; 
				if (document.documentElement && document.documentElement.scrollTop) { 
					scrollTop = document.documentElement.scrollTop; 
				} 
				else if (document.body) { 
					scrollTop = document.body.scrollTop; 
				} 
				return scrollTop; 
			} 
			
			//获取当前可视范围的高度 
			var getClientHeight = function() { 
				var clientHeight = 0; 
				if (document.body.clientHeight && document.documentElement.clientHeight) { 
					clientHeight = Math.min(document.body.clientHeight, document.documentElement.clientHeight); 
				}else{ 
					clientHeight = Math.max(document.body.clientHeight, document.documentElement.clientHeight); 
				} 
				return clientHeight; 
			} 
			
			//获取文档完整的高度 
			var getScrollHeight = function() { 
				return Math.max(document.body.scrollHeight, document.documentElement.scrollHeight); 
			} 
			window.onscroll = function(){
				if (getScrollTop() + getClientHeight() == getScrollHeight() && self.loadingComplete == true) { 
					self.getListData();
				} 
			};	
		},
		init : function(){
			this.getListData();
		}
	}
		
	App.init();
	
	document.addEventListener('DOMContentLoaded', function() {
		FastClick.attach(document.body);
	}, false);
	
});