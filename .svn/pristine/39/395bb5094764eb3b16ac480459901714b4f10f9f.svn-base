define(["app/tool","app/dialog","app/toast","app/login","lib/swipe","lib/fastclick"],function(t,dialog,toast,login) {
	"use strict";
	var App = {
		config : {
			detailUrl : 'MOCK/detail.json'+'?t='+new Date().getTime(),
			loginUrl : ''+'?t='+new Date().getTime()
		},
		tpl : {
			lvIcon : '<div class="lvIcon"><i></i><span>LV特供</span></div>',
			detailImgItem : '<div><img src="#{url}" /></div>',
			detailImgDotItem : '<i></i>',
			merchInfo : '\
			<div class="merchTitle">\
				<h1>#{name}</h1>\
				<div class="collection">\
					<i class="#{isFavorite}"></i>\
					<span>收藏</span>\
				</div>\
			</div>\
			<h2>#{scorePrice}<span>#{promotionWords}</span></h2>\
			<div class="lvInfo">#{lvInfo}</div>\
			<div class="lvScore">\
				<ul>#{lvScoreList}</ul>\
			</div>\
			<h3>\
				<span>#{saleAmount}人已兑</span>\
				<span>#{collectAmount}人已收藏</span>\
				<span>剩#{remainAmount}件</span>\
			</h3>',
			lvInfo : {
				"beforeLogin" : '<i>LV专享价最高省<strong>#{savePrice}</strong></i><b></b>',
				"login" : '<span>lv#{lvLevel}专享价</span><i>已省<strong>#{lvSavePrice}</strong></i><b></b>'	
			},
			lvScoreItem : '<li><span min="#{min}" max="#{max}"><strong>#{lvPrice}</strong>#{lvRange}</span></li>',
			relativeRecommendItem : '<li><a href="#{moreUrl}">#{name}</a></li>',
			popbox : {
				"test" : '\
				<section class="pop_wrap">\
					<h2>温馨提示</h2>\
					<h3>#{msg}</h3>\
					<div class="pop_btn_wrap">\
						<div class="pop_btn_item" id="#{leftBtn}">#{leftBtnTxt}</div>\
						<div class="pop_btn_item" id="#{rightBtn}">#{rightBtnTxt}</div>\
					</div>\
				</section>'	
			}
		},
		getDetailData : function(){
			var self = this;
			$.ajax({
				url:self.config.detailUrl,
				type:"GET",
				dataType:"json",
				success: function(data){
					self.data = data["data"];
					self.detailImg();
					self.merchInfo();
					self.detailTxt();
					self.relativeRecommend();
					dialog.ready();
					toast.ready();
					dialog.open(t.formatTpl(self.tpl.popbox.test,{},{
						"msg" : "是否确认兑换该商品",
						"leftBtnTxt" : "确定",	
						"rightBtnTxt" : "取消",
						"leftBtn" : "confirmBtn",
						"rightBtn" : "cancelBtn"
					}));
					self.popbox();
				},
				error: function(){
					alert("数据错误");	
				}	
			});	
		},
		detailImg : function(){
			var
			self = this,
			render = function(){
				var detailImgData = self.data.imgs;
				var detailImgList = '';
				var detailImgDotList = '';
				$.each(detailImgData,function(index){
					detailImgList += t.formatTpl(self.tpl.detailImgItem,{},detailImgData[index]);
					detailImgDotList += t.formatTpl(self.tpl.detailImgDotItem,{},{});	
				});
				$(".detailImgWrap").html(detailImgList);
				if(detailImgData.length>1){
					$(".detailImgDotWrap").html(detailImgDotList).find("i").eq(0).addClass("active");
				}
				handler();
			},
			handler = function(){
				var bannerObj = document.getElementById("detailImg");
				var bannerSwipe = Swipe(bannerObj, {
					startSlide: 0,
					//auto: 5000,
					continuous: true,
					disableScroll: false,
					stopPropagation: true,
					callback: function(index, element) {},
					transitionEnd: function(index, element) {
						$(".detailImgDotWrap i").removeClass("active");
						$(".detailImgDotWrap i").eq(index).addClass("active");
					}
				});	
			},
			init = function(){
				render();
			}
			init();
		},
		merchInfo : function(){
			var
			self = this,
			lvLoginInfo = function(){
				var lvInfoHtml = '';
				login.checkLogin(function(data){
					var lvLevel = data.userInfo.lvLevel;
					var lvList = self.data.lvs;
					var scorePrice = self.data.scorePrice;
					
						var lvSavePrice = (function(){
							if(lvList.length>0){
								var lvScore,i,len = lvList.length;
								for(var i=0;i<len;i++){
									if(lvLevel == lvList[i]["lv"]){
										lvScore = lvList[i]["scorePrice"];
										break;	
									}
								}
								return scorePrice - lvScore;
							}else{
								return 0;	
							}
						}());
					lvInfoHtml = t.formatTpl(self.tpl.lvInfo.login,{},{
						"lvLevel" : lvLevel,
						"lvSavePrice" : lvSavePrice
					});
					$(".lvInfo").html(lvInfoHtml);
					$.each($(".lvScore ul li"),function(index){
						var li = $(".lvScore ul li").eq(index);
						var span = li.find("span");
						var min = parseInt(span.attr("min"));
						var max = parseInt(span.attr("max"));
						if(max!=NaN){
							if(lvLevel >= min && lvLevel <= max){
								li.addClass("active");
							}
						}else{
							if(lvLevel == min){
								li.addClass("active");
							}
						}
					});
					
				},function(){
					lvInfoHtml = t.formatTpl(self.tpl.lvInfo.beforeLogin,{},{"savePrice":self.data.savePrice});
					$(".lvInfo").html(lvInfoHtml);
				});	
			},
			lvScoreList = function(){
				var lvScoreListHtml = '';
				var lvScoreData = self.data.lvs;
				var i,len = lvScoreData.length;
				var lvScoreObj = [],currentScore,minLv=0,maxLv;
				for(i=0;i<len;i++){
					if(lvScoreData[i+1]){
						if(parseInt(lvScoreData[i]["lv"])+1==parseInt(lvScoreData[i+1]["lv"]) && lvScoreData[i]["scorePrice"]==lvScoreData[i+1]["scorePrice"]){
							maxLv = lvScoreData[i+1]["lv"];
						}else{
							if(maxLv!=null){
								lvScoreObj.push({
									"lvPrice":lvScoreData[i]["scorePrice"],
									"lvRange":"LV"+minLv+"-"+"LV"+maxLv,
									"min" : minLv,
									"max" : maxLv
								});
								minLv = maxLv+1;
								maxLv = null;
							}else{
								lvScoreObj.push({
									"lvPrice":lvScoreData[i]["scorePrice"],
									"lvRange":"LV"+lvScoreData[i]["lv"],
									"min" : minLv
								});
							}
						}
					}else{
						lvScoreObj.push({
							"lvPrice":lvScoreData[i]["scorePrice"],
							"lvRange":"LV"+lvScoreData[i]["lv"],
							"min" : lvScoreData[i]["lv"]
						});	
					}
				}
				$.each(lvScoreObj,function(index){
					lvScoreListHtml += t.formatTpl(self.tpl.lvScoreItem,{},lvScoreObj[index]);
				});
				return lvScoreListHtml;	
			},
			lvMore = function(){
				$(".lvInfo").on("click",function(){
					$(this).find("b").toggleClass("active");
					$(".lvScore").toggle(); 	
				});	
			},
			isFavorite = function(){
				return self.data.isFavorite == true ? "active" : ""	
			},
			collection = function(){
				$(".collection").on("click",function(){
					if(!$(this).find("i").hasClass('active')){
						$(this).find("i").addClass("active");
					}
				});	
			},
			render = function(){
				var merchInfoData = self.data;
				var merchInfoHtml = '';
				merchInfoHtml += t.formatTpl(self.tpl.merchInfo,{
					"isFavorite" : isFavorite,
					"lvScoreList" : lvScoreList
				},merchInfoData);
				$("#merchInfo").html(merchInfoHtml);
				lvLoginInfo();
				if(merchInfoData.lv==true){
					$(".lvIcon").show();
				}else{
					$(".lvInfo").remove();
					$(".lvScore").remove();	
				}
			},
			init = function(){
				render();
				lvMore();
				collection();
			}
			init();
		},
		detailTxt : function(){
			var self = this;
			var txt = self.data.detail.replace(/\n/g,"<br/>");
			$("#merchDetail").html(txt);
			self.detailMore();	
		},
		detailMore : function(){
			if(parseInt($("#merchDetail").height())>=98){
				$(".merchDetailMore").show();
			}
			$(".merchDetailMore").on("click",function(){
				$(this).find("i").toggleClass("active");
				$(".merchDetail").toggleClass("merchDetailActive"); 	
			});	
		},
		relativeRecommend : function(){
			var html = '',self = this,relativeData = self.data.tags;
			$.each(relativeData,function(index){
				html += t.formatTpl(self.tpl.relativeRecommendItem,{},relativeData[index]);
			});
			$("#relativeRecommend").html(html);	
		},
		popbox : function(){
			$("#cancelBtn,#mask").on("click",function(){
				dialog.close();	
			});
		},
		init : function(){
			this.getDetailData();
			//toast.show("测试");
			console.log(t.formatDate('1437370000000','yyyy/MM/dd hh:mm:ss'));
			
		}
	}
		
	App.init();
	
	document.addEventListener('DOMContentLoaded', function() {
		FastClick.attach(document.body);
	}, false);
});