document.addEventListener('DOMContentLoaded', function(){
	LENOVO.ms.status.init();
	
	
});

var globaltimer,global_t;

//秒杀状态逻辑
LENOVO.namespace('LENOVO.ms.status');
LENOVO.ms.status = (function(){
	var 
	act_tips = document.querySelector("#act_tips"),
	miaosha_before = document.querySelector("#miaosha_before"),
	miaosha_btn = document.querySelector("#miaosha_btn"),
	
	url = 'activity.do',
	param = 't='+new Date().getTime(),
	init = function(){
		LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
			status = data.promotionStatus.status;
			deadline = data.promotionStatus.deadline;
			document.querySelector("#prize_pic").innerHTML = '<img src="static/'+data.prize.iconUrl+'" alt="'+data.prize.prizeDesc+'" width="200" />';
			document.querySelector("#prize_name").innerHTML = data.prize.prizeDesc;
			document.querySelector("#prize_score").innerHTML = data.prize.minScore+"分";	
			//status = 1;
			//deadline = '2014/5/24 14:00:00';
			if(status==1){ //倒计时阶段
				act_tips.innerHTML = '<h2><img src="static/images/icon8.png" /><span id="clock">00小时00分00秒</span></h2>';
				miaosha_before.style.display = 'block';
				miaosha_btn.style.display = 'none';
				LENOVO.com.countdown.init("clock",deadline,function(){
					act_tips.innerHTML = "<h2>活动已开始！</h2>";
					miaosha_before.style.display = 'none';
					miaosha_btn.style.display = 'block';
					LENOVO.ms.verifycode.init();
				});
			}else if(status==2){ //活动开始
				act_tips.innerHTML = '<h2>活动已开始！</h2>';
				miaosha_before.style.display = 'none';
				miaosha_btn.style.display = 'block';
				LENOVO.ms.verifycode.init();
				globaltimer = setInterval(function(){
					checkStatus3();
					
				},1000);
				
				
			}else if(status==3){
				act_tips.innerHTML = '<h2>活动已结束！</h2>';
				miaosha_before.innerHTML = '<span class="btn_grey">秒杀结束</span>';
			}
		});
	};
	return {init:init}
})()

//验证码
LENOVO.namespace('LENOVO.ms.verifycode');
LENOVO.ms.verifycode = (function(){
	var
	verify_img = document.querySelector("#verify_img"),
	get = function(){
		global_t = new Date().getTime();
		verify_img.innerHTML = '<img src="captcha.do?t='+global_t+'" />';
	},
	change = function(){
		verify_img.addEventListener('click',function(){
			get();	
		});
	},
	init = function(){
		get();
		change();
	}
	return {init:init}	
})()


//秒杀获奖信息提交
LENOVO.namespace('LENOVO.win.ms');
LENOVO.win.ms = (function(){
	var
	elements = function(){
		return document.querySelectorAll("#winner_tel input,#winner_tel select");
	},
	validate = function(){
		var
		allEle = elements(),
		i=0,
		len = allEle.length,
		val,
		name,
		param = new Object;
		for(;i<len;i++){
			val = allEle[i].value;
			name = allEle[i].name;
			if(val==""||val=="请选择"){
				window.App5.showToast("请填写相关内容");
				return false;
			}
			if(name=="phoneNumber" && !/^0{0,1}(13[0-9]|145|15[0-9]|18[0-9])[0-9]{8}$/.test(val)){
				window.App5.showToast("请正确填写手机号");
				return false;	
			}
			param[name] = val;
		}
		return param;
	},
	submit = function(){
		var param = validate();
		if(param){
			param = JSON.stringify(param);
			param = param.substring(1,param.length-1).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"");
			var bBtn = true;
			if(bBtn){
				bBtn = false;
				LENOVO.com.ajax.post('saveSecondKillPrizeContactInfo.do',param,{"clientid":getclientid()},function(data){
					bBtn = true;
					if(data.ret==true){
						closePop();
						window.App5.showToast("信息已提交");
					}else{
						window.App5.showToast(data.msg);	
					}
				});
			}
		}
	},
	init = function(){
		submit();
	};
	return{init : init}	
})()


//判断是否进入状态3（秒杀结束）
function checkStatus3(){
	var
	url = 'seckill.do',
	param = 't='+new Date().getTime();
	LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
		if(data.ret==false){
			clearInterval(globaltimer);
			LENOVO.ms.status.init();			
		}
	});
}


//秒杀按钮
function miaosha(){
	var 
	code = document.querySelector("#verify_box").value,
	ms_btn = document.querySelector("#ms_btn"),
	bBtn = true,
	url = 'secondkill.do',
	param = 'vc='+code+'&t='+global_t+'&cid='+getclientid();
	if(bBtn == true){
		bBtn = false;
		ms_btn.innerHTML = '<span class="btn_grey">秒杀</span>';
		LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
			setTimeout(function(){
				bBtn = true;
				ms_btn.innerHTML = '<a class="btn" onclick="miaosha()">秒杀</a>';
				document.querySelector("#verify_box").value = '';
				LENOVO.ms.verifycode.init();
			},500);
			if(data.ret == true){
				
				/*
				{
					"ret": true,
					"logId" : 11,
					"prize": {
						"prizeId": 11,
						"exchangeType": 0,
						"minScore": 1,
						"prizeDesc": "手机",
						"prizeType": 1,
						"orderNum": 11,
						"iconUrl": "prize/sj.jpg",
						"extraInfo": null
					}
				}
	
				*/
				
				var info = {
					"name" : data.prize.prizeDesc,
					"logId" : data.logId	
				}
				LENOVO.win.pop.init(4,{},info);
			}else{
				if(data.promotionStatus.status==4){
					var info = {
						"nextprize" : data.prize.prizeDesc,
						"nextprizetime"	: data.promotionStatus.nextSecondKillTime
					}
					LENOVO.win.pop.init(5,{},info);
				}else if(data.promotionStatus.status==5){
					var info = {
						"nextprize" : data.prize.prizeDesc,
						"nextprizetime"	: data.promotionStatus.nextSecondKillTime
					}
					LENOVO.win.pop.init(6,{},info);
				}else{
					window.App5.showToast(data.promotionStatus.statusDesc);	
				}
			}
		});
	}
}

//秒杀大奖提交信息
function submit_ms(){
	LENOVO.win.ms.init();	
}
