$(function(){
	var $garden,$loveHeart,gardenCanvas,gardenCtx,garden,offsetX,offsetY;
	$loveHeart = $("#loveHeart");
	offsetX = $loveHeart.width() / 2;
	offsetY = $loveHeart.height() / 2 - 55;
	$garden = $("#garden");
    gardenCanvas = $garden[0];
	gardenCanvas.width = $("#loveHeart").width();
    gardenCanvas.height = $("#loveHeart").height();
    gardenCtx = gardenCanvas.getContext("2d");
    gardenCtx.globalCompositeOperation = "lighter";
    garden = new Garden(gardenCtx, gardenCanvas);	
	// renderLoop
    setInterval(function () {
        garden.render();
    }, Garden.options.growSpeed);
	
	setTimeout(function(){
		$loveHeart.css("top",($(window).height()/2-325)+"px");
		startHeartAnimation();
	},500);
	
	function getHeartPoint(angle) {
		var t = angle / Math.PI;
		var x = 19.5 * (16 * Math.pow(Math.sin(t), 3));
		var y = - 20 * (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
		return new Array(offsetX + x, offsetY + y);
	}
	
	function startHeartAnimation() {
		var interval = 50;
		var angle = 10;
		var heart = new Array();
		var animationTimer = setInterval(function () {
			var bloom = getHeartPoint(angle);
			var draw = true;
			for (var i = 0; i < heart.length; i++) {
				var p = heart[i];
				var distance = Math.sqrt(Math.pow(p[0] - bloom[0], 2) + Math.pow(p[1] - bloom[1], 2));
				if (distance < Garden.options.bloomRadius.max * 1.3) {
					draw = false;
					break;
				}
			}
			if (draw) {
				heart.push(bloom);
				garden.createRandomBloom(bloom[0], bloom[1]);
			}
			if (angle >= 30) {
				clearInterval(animationTimer);
				showMessages();
			} else {
				angle += 0.2;
			}
		}, interval);
	}
	
	function adjustWordsPosition() {
		$('#words').css("position", "absolute");
		$('#words').css("top", $("#garden").position().top + 195);
		$('#words').css("left", $("#garden").position().left + 70);
	}
	
	function showMessages() {
		//adjustWordsPosition();
		$('#words').fadeIn(100);
		$("#words").typewriter(function(){
			$("#words strong").animate({"marginRight":20},800,function(){
				$("#words strong").css({"font-weight":"bold","color":"#F99"});	
			});
		});
		
	}
	
	
	
});

(function(a) {
    a.fn.typewriter = function(fn) {
        this.each(function() {
            var d = a(this),
            c = d.html(),
            b = 0;
            d.html("");
            var e = setInterval(function() {
                var f = c.substr(b, 1);
                if (f == "<") {
                    b = c.indexOf(">", b) + 1
                } else {
                    b++;
                }
                d.html(c.substring(0, b) + (b & 1 ? "_": ""));
                if (b >= c.length) {
                    clearInterval(e);
					d.html(c.substring(0, b));
					fn();
                }
            },75);
        });
        return this
    }
})(jQuery);


(function(){
	var imgUrl = "http://lechan.sinaapp.com/heart/images/icon.jpg";
	var lineLink = "http://lechan.sinaapp.com/heart/index.html";
	var descContent = "你哭、你笑、你作、你闹，我要";
	var shareTitle = "触 &middot; 爱";
	var appid = '';
	 
	function shareFriend() {
		WeixinJSBridge.invoke('sendAppMessage',{
			"appid": appid,
			"img_url": imgUrl,
			"img_width": "200",
			"img_height": "200",
			"link": lineLink,
			"desc": descContent,
			"title": shareTitle
		}, function(res) {
			//_report('send_msg', res.err_msg);
		})
	}
	function shareTimeline() {
		WeixinJSBridge.invoke('shareTimeline',{
			"img_url": imgUrl,
			"img_width": "200",
			"img_height": "200",
			"link": lineLink,
			"desc": descContent,
			"title": shareTitle
		}, function(res) {
			   //_report('timeline', res.err_msg);
		});
	}
	function shareWeibo() {
		WeixinJSBridge.invoke('shareWeibo',{
			"content": descContent,
			"url": lineLink,
		}, function(res) {
			//_report('weibo', res.err_msg);
		});
	}
	// 当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
	document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
		// 发送给好友
		WeixinJSBridge.on('menu:share:appmessage', function(argv){
			shareFriend();
		});
		// 分享到朋友圈
		WeixinJSBridge.on('menu:share:timeline', function(argv){
			shareTimeline();
		});
		// 分享到微博
		WeixinJSBridge.on('menu:share:weibo', function(argv){
			shareWeibo();
		});
	}, false);	
})()