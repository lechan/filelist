define(["app/tool","app/dialog","app/toast","app/login","lib/swipe","lib/fastclick"],function(t,dialog,toast,login) {
	"use strict";
	var App = {
		config : {
			detailUrl : 'MOCK/detail.json'+'?t='+new Date().getTime(),
			loginUrl : ''+'?t='+new Date().getTime()
		},
		tpl : {
			lvIcon : '<div class="lvIcon"><i></i><span>LV特供</span></div>',
			detailImgItem : '<div><img src="#{url}" /></div>',
			detailImgDotItem : '<i></i>',
			merchInfo : '\
			<div class="merchTitle">\
				<h1>#{name}</h1>\
				<div class="collection">\
					<i class="#{isFavorite}"></i>\
					<span>收藏</span>\
				</div>\
			</div>\
			<h2><strong id="scorePrice">#{scorePrice}</strong><span>#{promotionWords}</span></h2>\
			<div class="lvInfo">#{lvInfo}</div>\
			<div class="lvScore">\
				<ul>#{lvScoreList}</ul>\
			</div>\
			<h3>\
				<span>#{saleAmount}人已兑</span>\
				<span>#{favoriteAmount}人已收藏</span>\
				<span>剩#{remainAmount}件</span>\
			</h3>',
			lvInfo : {
				"beforeLogin" : '<i>LV专享价最高省<strong>#{savePrice}</strong></i><b></b>',
				"login" : '<span>lv#{lvLevel}专享价</span><i>已省<strong>#{lvSavePrice}</strong></i><b></b>'	
			},
			lvScoreItem : '<li><span min="#{min}" max="#{max}"><strong>#{lvPrice}</strong>#{lvRange}</span></li>',
			relativeRecommendItem : '<li><a href="#{moreUrl}">#{name}</a></li>',
			exchangeBtn : {
				"able" : '<div class="exchangeBtn">兑换<span>#{lvSavePrice}</span></div>',
				"disable" : '<div class="exchangeBtnGrey">暂无库存，可收藏后，有库存再购买</div>'	
			},
			popbox : {
				"tips" : '\
				<section class="pop_wrap">\
					<h2>#{title}</h2>\
					<h3>#{msg}</h3>\
					<div class="pop_btn_wrap">\
						<div class="pop_btn_item" id="#{leftBtn}">#{leftBtnTxt}</div>\
						<div class="pop_btn_item" id="#{rightBtn}">#{rightBtnTxt}</div>\
					</div>\
				</section>'	
			}
		},
		popCodeMap : [{
			"code" : "1",
			"popInfo" : {
				"title" : "温馨提示",
				"msg" : "您还差#{score}积分就可以兑换当前商品，用户中心一大波好玩任务等您体验",
				"leftBtnTxt" : "取消",	
				"rightBtnTxt" : "去赚积分",
				"leftBtn" : "cancelBtn",
				"rightBtn" : "goToScore"
			}	
		},{
			"code" : "2",
			"popInfo" : {
				"title" : "温馨提示",
				"msg" : "该商品属于指定LV专享，高于LV1的用户都有自己的专属商品，可到LV专区查看",
				"leftBtnTxt" : "取消",	
				"rightBtnTxt" : "去LV专区",
				"leftBtn" : "cancelBtn",
				"rightBtn" : "goToLv"
			}	
		},{
			"code" : "3",
			"popInfo" : {
				"title" : "温馨提示",
				"msg" : "您还没有安装该应用，赶紧安装，立即兑换！",
				"leftBtnTxt" : "安装",	
				"rightBtnTxt" : "先兑换",
				"leftBtn" : "installBtn",
				"rightBtn" : "confirmBtn"
			}	
		},{
			"code" : "4",
			"popInfo" : {
				"title" : "订单确认",
				"msg" : "#{orderInfo}",
				"leftBtnTxt" : "取消",	
				"rightBtnTxt" : "确认",
				"leftBtn" : "cancelBtn",
				"rightBtn" : "confirmBtn"
			}	
		},{
			"code" : "5",
			"popInfo" : {
				"title" : "兑换成功",
				"msg" : "恭喜您兑换已成功，商城将尽快安排发货，查看订单状态请进入订单列表！",
				"leftBtnTxt" : "查看订单",	
				"rightBtnTxt" : "继续兑换",
				"leftBtn" : "goToOrder",
				"rightBtn" : "cancelBtn"
			}	
		}],
		getDetailData : function(){
			var self = this;
			$.ajax({
				url:self.config.detailUrl,
				type:"GET",
				dataType:"json",
				success: function(data){
					self.data = data["data"];
					self.detailImg();
					self.merchInfo();
					self.detailTxt();
					self.relativeRecommend();
					dialog.ready();
					toast.ready();
				},
				error: function(){
					alert("数据错误");	
				}	
			});	
		},
		detailImg : function(){
			var
			self = this,
			render = function(){
				var detailImgData = self.data.imgs;
				var detailImgList = '';
				var detailImgDotList = '';
				$.each(detailImgData,function(index){
					detailImgList += t.formatTpl(self.tpl.detailImgItem,{},detailImgData[index]);
					detailImgDotList += t.formatTpl(self.tpl.detailImgDotItem,{},{});	
				});
				$(".detailImgWrap").html(detailImgList);
				if(detailImgData.length>1){
					$(".detailImgDotWrap").html(detailImgDotList).find("i").eq(0).addClass("active");
				}
				handler();
			},
			handler = function(){
				var bannerObj = document.getElementById("detailImg");
				var bannerSwipe = Swipe(bannerObj, {
					startSlide: 0,
					//auto: 5000,
					continuous: true,
					disableScroll: false,
					stopPropagation: true,
					callback: function(index, element) {},
					transitionEnd: function(index, element) {
						$(".detailImgDotWrap i").removeClass("active");
						$(".detailImgDotWrap i").eq(index).addClass("active");
					}
				});	
			},
			init = function(){
				render();
			}
			init();
		},
		exchangeBtnStatus : function(isLv,lvSavePrice){
			var html,self = this;
			if(self.data.remainAmount>0){
				if(isLv){
					html = t.formatTpl(self.tpl.exchangeBtn.able,{},{"lvSavePrice":"（省<strong>"+lvSavePrice+"</strong>）"});
				}else{
					html = t.formatTpl(self.tpl.exchangeBtn.able,{},{});
				}
			}else{
				html = t.formatTpl(self.tpl.exchangeBtn.disable,{},{});
			}
			$("#exchangeBtn").html(html);
			self.exchange();
		},
		merchInfo : function(){
			var
			self = this,
			lvLoginInfo = function(){
				var lvInfoHtml = '';
				login.checkLogin(function(data){
					var isLv = self.data.lv;
					var lvLevel = data.userInfo.lvLevel;
					var lvList = self.data.lvs;
					var scorePrice = self.data.scorePrice;
					var lvScore;
					var lvSavePrice = (function(){
						if(lvList.length>0){
							var i,len = lvList.length;
							for(var i=0;i<len;i++){
								if(lvLevel == lvList[i]["lv"]){
									lvScore = lvList[i]["scorePrice"];
									break;	
								}
							}
							return scorePrice - lvScore;
						}else{
							return 0;	
						}
					}());
					lvInfoHtml = t.formatTpl(self.tpl.lvInfo.login,{},{
						"lvLevel" : lvLevel,
						"lvSavePrice" : lvSavePrice
					});
					$(".lvInfo").html(lvInfoHtml);
					$("#scorePrice").html(lvScore);
					$.each($(".lvScore ul li"),function(index){
						var li = $(".lvScore ul li").eq(index);
						var span = li.find("span");
						var min = parseInt(span.attr("min"));
						var max = parseInt(span.attr("max"));
						if(max!=NaN){
							if(lvLevel >= min && lvLevel <= max){
								li.addClass("active");
							}
						}else{
							if(lvLevel == min){
								li.addClass("active");
							}
						}
					});
					
					self.exchangeBtnStatus(isLv,lvSavePrice);
					
				},function(){
					lvInfoHtml = t.formatTpl(self.tpl.lvInfo.beforeLogin,{},{"savePrice":self.data.savePrice});
					$(".lvInfo").html(lvInfoHtml);
					
					self.exchangeBtnStatus();
					
				});	
			},
			lvScoreList = function(){
				var lvScoreListHtml = '';
				var lvScoreData = self.data.lvs;
				var i,len = lvScoreData.length;
				var lvScoreObj = [],currentScore,minLv=0,maxLv;
				for(i=0;i<len;i++){
					if(lvScoreData[i+1]){
						if(parseInt(lvScoreData[i]["lv"])+1==parseInt(lvScoreData[i+1]["lv"]) && lvScoreData[i]["scorePrice"]==lvScoreData[i+1]["scorePrice"]){
							maxLv = lvScoreData[i+1]["lv"];
						}else{
							if(maxLv!=null){
								lvScoreObj.push({
									"lvPrice":lvScoreData[i]["scorePrice"],
									"lvRange":"LV"+minLv+"-"+"LV"+maxLv,
									"min" : minLv,
									"max" : maxLv
								});
								minLv = maxLv+1;
								maxLv = null;
							}else{
								lvScoreObj.push({
									"lvPrice":lvScoreData[i]["scorePrice"],
									"lvRange":"LV"+lvScoreData[i]["lv"],
									"min" : minLv
								});
							}
						}
					}else{
						lvScoreObj.push({
							"lvPrice":lvScoreData[i]["scorePrice"],
							"lvRange":"LV"+lvScoreData[i]["lv"],
							"min" : lvScoreData[i]["lv"]
						});	
					}
				}
				$.each(lvScoreObj,function(index){
					lvScoreListHtml += t.formatTpl(self.tpl.lvScoreItem,{},lvScoreObj[index]);
				});
				return lvScoreListHtml;	
			},
			lvMore = function(){
				$(".lvInfo").on("click",function(){
					$(this).find("b").toggleClass("active");
					$(".lvScore").toggle(); 	
				});	
			},
			isFavorite = function(){
				return self.data.isFavorite == true ? "active" : ""	
			},
			collection = function(){
				$(".collection").on("click",function(){
					if(!$(this).find("i").hasClass('active')){
						$(this).find("i").addClass("active");
					}
				});	
			},
			render = function(){
				var merchInfoData = self.data;
				var merchInfoHtml = '';
				merchInfoHtml += t.formatTpl(self.tpl.merchInfo,{
					"isFavorite" : isFavorite,
					"lvScoreList" : lvScoreList
				},merchInfoData);
				$("#merchInfo").html(merchInfoHtml);
				lvLoginInfo();
				if(merchInfoData.lv==true){
					$(".lvIcon").show();
				}else{
					$(".lvInfo").remove();
					$(".lvScore").remove();	
				}
			},
			init = function(){
				render();
				lvMore();
				collection();
			}
			init();
		},
		detailTxt : function(){
			var self = this;
			var txt = self.data.detail.replace(/\n/g,"<br/>");
			$("#merchDetail").html(txt);
			self.detailMore();	
		},
		detailMore : function(){
			if(parseInt($("#merchDetail").height())==(20*8-2)){
				$(".merchDetailMore").show();
			}
			$(".merchDetailMore").on("click",function(){
				$(this).find("i").toggleClass("active");
				$(".merchDetail").toggleClass("merchDetailActive"); 	
			});	
		},
		relativeRecommend : function(){
			var html = '',self = this,relativeData = self.data.tags;
			$.each(relativeData,function(index){
				html += t.formatTpl(self.tpl.relativeRecommendItem,{},relativeData[index]);
			});
			$("#relativeRecommend").html(html);	
		},
		exchange : function(){
			var self = this;
			$("#exchangeBtn").on("click",function(){
				if($("#exchangeBtn div").hasClass("exchangeBtn")){
					alert(t.formatTpl(self.tpl.popbox.tips,{},self.popCodeMap[0]["popInfo"]));
					dialog.open(t.formatTpl(self.tpl.popbox.tips,{},self.popCodeMap[0]["popInfo"]));
					self.popbox();	
				}
			});	
		},
		popbox : function(){
			$("#cancelBtn,#mask").on("click",function(){
				dialog.close();	
			});
		},
		init : function(){
			this.getDetailData();
			//toast.show("测试");
			//console.log(t.formatDate('1437370000000','yyyy/MM/dd hh:mm:ss'));
			
		}
	}
		
	App.init();
	
	document.addEventListener('DOMContentLoaded', function() {
		FastClick.attach(document.body);
	}, false);
});