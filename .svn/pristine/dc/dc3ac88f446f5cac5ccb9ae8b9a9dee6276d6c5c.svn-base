document.addEventListener('DOMContentLoaded', function(){
	LENOVO.com.tab.init("tab","click");
	LENOVO.prize.hash.init();
	LENOVO.prize.list.init();
});



//通过hash值判断进入是全部奖品还是我的奖品
LENOVO.namespace('LENOVO.prize.hash');
LENOVO.prize.hash = (function(){
	var
	hashcode = window.location.search;
	init = function(){
		if(hashcode){
			document.querySelectorAll("#tab li")[1].onclick();
			setTimeout(function(){
				LENOVO.prize.mine.init();
			},500);
			/*setTimeout(function(){
				var tab_btn = document.querySelectorAll('#tab ul.tab_btn li');
				var tab_con = document.querySelectorAll('#tab div.tab_con > div');
				for(var j=0;j<2;j++){
					tab_con[j].style.display = 'none';	
					LENOVO.com.node.removeClass(tab_btn[j],"active");
				}
				tab_con[1].style.display = 'block';
				LENOVO.com.node.addClass(tab_btn[1],"active");
			},1000);*/
		}else{
			LENOVO.prize.mine.init();
		}
	}
	return {init:init}
})()

//全部奖品列表
LENOVO.namespace('LENOVO.prize.list');
LENOVO.prize.list = (function(){
	var
	get = function(){
		var url = 'prize.do',
		param = 't='+new Date().getTime(),
		html = '',
		score1 = document.querySelector("#score1"),
		score2 = document.querySelector("#score2"),
		prizelist,
		len,
		i;
		LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
			score1.innerHTML = data.userScore;
			score2.innerHTML = data.userScore;
			myData.userScore = data.userScore;
			prizelist = data.globalPrizeList;
			if(prizelist){
				len = prizelist.length;
				for(i=0;i<len;i++){
					html +=	'\
					<li>\
                    	<div class="fl prize_list_l">\
                        	<h2>'+prizelist[i].prizeDesc+'</h2>\
                            <h3>'+prizelist[i].minScore+'积分 剩余'+prizelist[i].retainedAmount+'份 '+
							(function(){
								return prizelist[i].retainedAmount==0 ? '<em>'+prizelist[i].nextSupplyTime+'</em>' : '';
							})()
							+'</h3>\
                        </div>\
                        <div class="fr prize_list_r">'+
							(function(){
								return prizelist[i].retainedAmount>0 ? '<a class="btn" data-type="'+prizelist[i].exchangeType+'" data-prizename="'+prizelist[i].prizeDesc+'" data-prizeid="'+prizelist[i].prizeId+'" data-prizescore="'+prizelist[i].minScore+'" onclick="getPrize(this)">兑奖</a>' : '<span class="btn_grey">已兑完</span>';
							})()
							+'</div>\
                    </li>';
				}
				
				document.querySelector("#allprize").innerHTML = html;
			}
			
		});
	},
	init = function(){
		get();
	};
	return {init:init}	
})()


//我的奖品列表
LENOVO.namespace('LENOVO.prize.mine');
LENOVO.prize.mine = (function(){
	var
	get = function(){
		var url = 'prize.do',
		param = 't='+new Date().getTime(),
		html = '',
		prizelist,
		len,
		i;
		LENOVO.com.ajax.get(url,param,{"clientid":getclientid()},function(data){
			document.querySelector("#minScoreToExchanagePrize").innerHTML = data.minScoreToExchanagePrize;
			document.querySelector("#prizeNumToExchange").innerHTML = data.prizeNumToExchange;
			
			prizelist = data.userPrizeList;
			if(prizelist){
				len = prizelist.length;
				
				if(len==0){
					if(data.userScore < data.minScoreToExchanagePrize){
						document.querySelector("#myprize_none").style.display = 'block';	
					}else{
						document.querySelector("#myprize_none2").style.display = 'block';		
					}
				}else{
					document.querySelector("#myprize_none").style.display = 'none';
					document.querySelector("#myprize_none2").style.display = 'none';
					for(i=0;i<len;i++){
						html +=	'\
						<li>\
							<div class="fl prize_list_l">'+
							(function(){
								if(prizelist[i].exchangeType==1){
									return '<h2>'+prizelist[i].prizeDesc+'<br/>卡密：'+prizelist[i].exchangeInfo.cardNumber+'</h2>';
								}else{
									return '<h2>'+prizelist[i].prizeDesc+'</h2>';
								}
							})()
							+'<h3>时间：'+prizelist[i].exchangedTime+'</h3>\
							</div>\
						</li>';
					}
					document.querySelector("#myprize").innerHTML = html;
					
				}
			}
			
		});
	},
	init = function(){
		get();
	};
	return {init:init}	
})()


//手机获奖信息提交
LENOVO.namespace('LENOVO.win.mob');
LENOVO.win.mob = (function(){
	var
	elements = function(){
		return document.querySelectorAll("#winner_tel input,#winner_tel select");
	},
	validate = function(){
		var
		allEle = elements(),
		i=0,
		len = allEle.length,
		val,
		name,
		param = new Object;
		for(;i<len;i++){
			val = allEle[i].value;
			name = allEle[i].name;
			if(val==""||val=="请选择"){
				window.App5.showToast("请填写相关内容");
				return false;
			}
			if(name=="phoneNumber" && !/^0{0,1}(13[0-9]|145|15[0-9]|18[0-9])[0-9]{8}$/.test(val)){
				window.App5.showToast("请正确填写手机号");
				return false;	
			}
			param[name] = val;
		}
		return param;
	},
	submit = function(){
		var param = validate();
		if(param){
			param = JSON.stringify(param);
			param = param.substring(1,param.length-1).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"");
			var bBtn = true;
			if(bBtn){
				bBtn = false;
				LENOVO.com.ajax.post('savePrizeTypeOneContactInfo.do',param,{"clientid":getclientid()},function(data){
					bBtn = true;
					if(data.ret==true){
						LENOVO.prize.mine.init();
						closePop();
						window.App5.showToast("信息已提交");
					}else{
						window.App5.showToast(data.msg);	
					}
				});
			}
		}
	},
	init = function(){
		submit();
	};
	return{init : init}	
})()

//电话卡获奖信息提交
LENOVO.namespace('LENOVO.win.card');
LENOVO.win.card = (function(){
	var
	elements = function(){
		return document.querySelectorAll("#winner_card input,#winner_card select");
	},
	validate = function(){
		var
		allEle = elements(),
		i=0,
		len = allEle.length,
		val,
		name,
		param = new Object;
		for(;i<len;i++){
			val = allEle[i].value;
			name = allEle[i].name;
			if(val==""||val=="请选择"){
				window.App5.showToast("请填写相关内容");
				return false;
			}
			if(name=="phoneNumber" && !/^0{0,1}(13[0-9]|145|15[0-9]|18[0-9])[0-9]{8}$/.test(val)){
				window.App5.showToast("请正确填写手机号");
				return false;	
			}
			param[name] = val;
		}
		return param;
	},
	submit = function(){
		var param = validate();
		if(param){
			param = JSON.stringify(param);
			param = param.substring(1,param.length-1).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"");
			var bBtn = true;
			if(bBtn){
				bBtn = false;
				LENOVO.com.ajax.post('savePrizeTypeThreeContactInfo.do',param,{"clientid":getclientid()},function(data){
					bBtn = true;
					if(data.ret==true){
						LENOVO.prize.mine.init();
						closePop();
						window.App5.showToast("信息已提交");
					}else{
						window.App5.showToast(data.msg);	
					}	
				});
			}
		}
	},
	init = function(){
		submit();
	};
	return{init : init}	
})()




//秒杀获奖信息提交
LENOVO.namespace('LENOVO.win.ms');
LENOVO.win.ms = (function(){
	var
	elements = function(){
		return document.querySelectorAll("#winner_tel input,#winner_tel select");
	},
	validate = function(){
		var
		allEle = elements(),
		i=0,
		len = allEle.length,
		val,
		name,
		param = new Object;
		for(;i<len;i++){
			val = allEle[i].value;
			name = allEle[i].name;
			if(val==""||val=="请选择"){
				window.App5.showToast("请填写相关内容");
				return false;
			}
			if(name=="phoneNumber" && !/^0{0,1}(13[0-9]|145|15[0-9]|18[0-9])[0-9]{8}$/.test(val)){
				window.App5.showToast("请正确填写手机号");
				return false;	
			}
			param[name] = val;
		}
		return param;
	},
	submit = function(){
		var param = validate();
		if(param){
			param = JSON.stringify(param);
			param = param.substring(1,param.length-1).replace(/,/g,"&").replace(/:/g,"=").replace(/"/g,"");
			var bBtn = true;
			if(bBtn){
				bBtn = false;
				LENOVO.com.ajax.post('saveSecondKillPrizeContactInfo.do',param,{"clientid":getclientid()},function(data){
					bBtn = true;
					if(data.ret==true){
						LENOVO.prize.mine.init();
						closePop();
						window.App5.showToast("信息已提交");
					}else{
						window.App5.showToast(data.msg);	
					}
				});
			}
		}
	},
	init = function(){
		submit();
	};
	return{init : init}	
})()







//切换到兑奖列表
function gotolist(){
	document.querySelectorAll("#tab li")[0].onclick();
}





//兑换手机提交信息
function submit_mob(){
	LENOVO.win.mob.init();	
}

//兑换充值卡提交信息
function submit_telcard(){
	LENOVO.win.card.init();	
}

//秒杀大奖提交信息
function submit_ms(){
	LENOVO.win.ms.init();	
}

//改变积分数
function scoreChange(score){
	myData.score = score;
	document.querySelector(".score").innerHTML = score;
}

//获奖弹窗
function win_edit(e){
	var type = e.getAttribute('data-type');
	var info = e.getAttribute('data-info');
	var prizeinfo = {
		'name' : e.getAttribute('data-prizeinfo')
	}
	LENOVO.win.pop.init(type,JSON.parse(info),prizeinfo);	
}