define(["app/tool"],function(t) {
	"use strict";
	/**
	 * lenovoid登录相关
	 * @return {Function} login(callback) [登录]
	 * @return {Function} checkLogin() [检查登录]
	 */
	var lenovoid = (function(){
		var
		bBtn = true,
		config = {
			domain : window.location.host,
			url : 'MOCK/loginInfo.json'+'?t='+new Date().getTime()
		},
		//获取lpsust
		getLpsUst = function(){
			var 
			lpsust,
			realm = (function(){return config.domain == 'beta.test2.surepush.cn'?'test.appstore.lps.lenovo.com':'appstore.lps.lenovo.com'})();
			if(global && typeof(global.getLpsUst)!="undefined"){
				if(parseInt(global.getVersionCode()) < 61000){
					lpsust = global.getLpsUst(0);
				}else{
					lpsust = global.getLpsUst(realm,0);
				}
			}else{
				lpsust = t.cookie.get("lpsust");
				if(lpsust=="null"){
					lpsust = '';	
				}
			}
			
			return typeof(lpsust) == 'undefined' ? '' : lpsust;
			
		},
		loginStatusChange = function(data){
				
		},
		checkLogin = function(){
			$.get(config.url,function(data){
				if(data.status==false){
					login();
					return false;
				}else{
					return true;
					//登录信息写入
					loginStatusChange(data);
					
				}
			});
		},
		login = function(callback){
			if(global){
				if(bBtn == true){
					bBtn = false;
					setTimeout(function(){
						bBtn = true;
						
						if(typeof(global.getLpsUst)=="undefined"){
							//LENOVO.win.pop.init(15);
							return false;
							//window.location.reload();
						}else{
							global.showLogin();	
							
							var timer = null;
							if(typeof(global.getLpsUst)!="undefined"){
								timer = setInterval(function(){
									//alert("lpsust:"+getLpsUst());
									if(getLpsUst()!=''){
										
										clearInterval(timer);
										checkLogin();
										
										/*if(BASE.currentFn!=null){
											setTimeout(function(){
												eval(BASE.currentFn)();
												BASE.currentFn = null;
											},200);
										}*/
									}
								},500);
							}else{
								
								if(getLpsUst()!=''){
									checkLogin();	
								}
							}	
						}
					},500);
					
				}
			}else{
				var fileurl = (function(){
					var url = window.location.pathname;
					while(url.indexOf("/") > -1) {
						url = url.substring(url.indexOf("/") + 1, url.length);
					}
					return url;
				})()
				window.location.href = 'lenovoLogin.do?toPath=/'+fileurl;
			}
		};
		return {login:login,checkLogin:checkLogin}
	}());
	//module.exports = lenovoid;
	return lenovoid;
});