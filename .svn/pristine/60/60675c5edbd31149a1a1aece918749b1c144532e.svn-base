define(["app/tool","app/lazyload","lib/fastclick"],function(t,lazy) {
	"use strict";
	var App = {
		config : {
			listUrl : 'MOCK/list.json'+'?t='+new Date().getTime(),
			loginUrl : ''+'?t='+new Date().getTime()
		},
		tpl : {
			listItem : '\
			<li class="#{islv}">\
                <a href="#{url}">\
                	#{lvIcon}\
                    <div class="listImg"><img class="lazy" dataimg="#{iconAddr}" src="images/grey.png"></div>\
                    <h3>#{name}</h3>\
                    <h4><strong>#{scorePrice}</strong><i>#{promotionWords}</i></h4>\
                    #{lvTips}\
                    <h5>仅剩#{remainAmount}件</h5>\
                </a>\
            </li>\
			',
			lvIcon : '<div class="lvIcon"><i></i><span>LV特供</span></div>',
			lvTips : '<div class="lvTips"><i>最多省<strong>#{savePrice}</strong></i></div>',
			popbox : {
				"test" : '\
				<section class="pop_wrap">\
					<h2 style="padding:20px 0px;">测试弹窗</h2>\
				</section>'	
			}
		},
		getListData : function(){
			var self = this;
			$.ajax({
				url:self.config.listUrl,
				type:"GET",
				dataType:"json",
				success: function(data){
					self.data = data;
					self.renderList();
				},
				error: function(){
					alert("数据错误");	
				}	
			});	
		},
		renderList : function(){
			var self = this;
			var listData = self.data.merchs;
			var listHtml = '';
			var lvIcon,lvTips;
			$.each(listData,function(index){
				lvIcon = t.formatTpl(self.tpl.lvIcon,{},{});
				lvTips = t.formatTpl(self.tpl.lvTips,{},{});
				listHtml += t.formatTpl(self.tpl.listItem,{
					"islv" : function(){return listData[index]["lv"] ? "lvItem" : ""},
					"lvIcon" : function(){return listData[index]["lv"] ? lvIcon : ""},
					"lvTips" : function(){return listData[index]["lv"] ? lvTips : ""}
				},listData[index]);
			});
			
			$(".mainList ul").html(listHtml);
			lazy.init();
		},
		navHandler : function(){
			var closeNavPop = function(){
				$("#nav_select").hide();
				$("#nav_tag").hide();
				$("#selectBtn")[0].className = "";
				$("#selectBtn").find("i")[0].className = "arrow_down pos1";
				$("#tagBtn")[0].className = "";
				$("#tagBtn").find("i")[0].className = "arrow_down pos1";
			}
			$("#tagBtn").on("click",function(){
				$(this).toggleClass("active up");
				$(this).find("i").toggleClass("arrow_down arrow_up");
				$("#nav_tag").toggle();
				$("#nav_select").hide();
				$("#selectBtn")[0].className = "";
				$("#selectBtn").find("i")[0].className = "arrow_down pos1";
			});	
			$("#salesBtn").on("click",function(){
				closeNavPop();
				$(this).toggleClass("active");
			});	
			$("#priceBtn").on("click",function(){
				closeNavPop();
				if($(this).hasClass("active")){
					if($(this).hasClass("up")){
						$(this).removeClass("up").addClass("down");
					}else if($(this).hasClass("down")){
						$(this).removeClass("down").addClass("up");
					}
				}else{
					$(this).addClass("active up");
				}
			});	
			$("#selectBtn").on("click",function(){
				$(this).toggleClass("active up");
				$(this).find("i").toggleClass("arrow_down arrow_up");
				$("#nav_select").toggle();
				$("#nav_tag").hide();
				$("#tagBtn")[0].className = "";
				$("#tagBtn").find("i")[0].className = "arrow_down pos1";
			});	
			$(".nav_mask").on("click",function(){
				closeNavPop();	
			});
			
			$("#nav_tag ul li").on("click",function(){
				closeNavPop();
				$("#nav_tag ul li").removeClass("active");
				$(this).addClass("active");
				$("#tagBtn span").eq(0).html($(this).html());
				
			});
			
			$("#nav_select ul li").on("click",function(){
				$(this).parent("ul").find("li").removeClass("active");
				$(this).addClass("active");
			});
			
			$("#selectConfirmBtn").on("click",function(){
				closeNavPop();
					
			});
			
		},
		init : function(){
			this.getListData();
			this.navHandler();			
		}
	}
		
	App.init();
	
	document.addEventListener('DOMContentLoaded', function() {
		FastClick.attach(document.body);
	}, false);
	
});